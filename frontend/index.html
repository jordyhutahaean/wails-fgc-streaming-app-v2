<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Scoreboard Control</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f5f7fa;
    --card-bg:#fff;
    --panel:#ffffff;
    --border:#dcdfe3;
    --accent:#0077ff;
    --muted:#666;
    --text:#222;
    --win:#5a5a5a;
    --lose:#fff5f5;
  }
/* googoo */
/* gaagaa */
  html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter, Arial, sans-serif;color:var(--text)}
  .container{padding:20px;max-width:1200px;margin:0 auto}
  h1{margin:0 0 18px;font-size:20px;color:var(--accent)}

  /* Top tabs */
  .tab{display:flex;gap:10px;border-bottom:2px solid var(--border);margin-bottom:18px}
  .tab button{background:none;border:0;padding:10px 14px;cursor:pointer;font-weight:700;border-radius:6px;color:var(--text)}
  .tab button.active{background:var(--accent);color:#fff}
  .tabcontent{display:none}
  .tabcontent.active{display:block}

  /* toolbar & controls */
  .toolbar{display:flex;gap:10px;margin-bottom:18px}
  button.btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.btn:hover{filter:brightness(.9)}
  .settings{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:18px}
  .settings label{display:flex;flex-direction:column;font-weight:700;font-size:13px}
  input[type="text"], input[type="number"], select{margin-top:6px;padding:8px;border:1px solid var(--border);border-radius:6px;min-width:26px}

  .playerflex{display:flex;gap:12px;flex-wrap:wrap;flex-direction: row;}
  .player-block{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start;flex-direction: column;}
  .player-block label{font-weight:700;font-size:13px;min-width:150px ; display: flex; flex-direction: column;}

  /* commentary */
  .commentary-panel{padding:14px;background:var(--panel);border:1px solid var(--border);border-radius:10px}
  .commentator-block{display:flex;gap:24px;flex-wrap:nowrap;margin-bottom:8px}

  .commentator-block label {
    font-size: 12px;
    display: flex;
    gap: 4px;
    flex-direction: column;
  }
  .commentary-toolbar{display:flex;gap:8px;margin-top:25px}

  /* Bracket Panel layout (horizontal tournament tree) */
  .bracket-panel{padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:10px}

  .inner-tabs #singleTabBtn, .inner-tabs #doubleTabBtn{font-size:12px}


  .inner-tabs{display:flex;gap:10px;margin-bottom:14px}
  .inner-tabs button{background:none;border:1px solid var(--border);padding:8px 10px;border-radius:8px;cursor:pointer}
  .inner-tabs button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  .round{display:flex;flex-direction:column;gap:18px;min-width:220px}
  .round .round-title{text-align:center;font-weight:800;color:var(--muted);margin-bottom:6px}
  
  .match{width: 240px;display: table; background:#f8fbff;border:1px solid var(--border);border-radius:8px;padding:8px 10px;position:relative;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
  .match .player-line{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px;border-radius:6px}
  .match .player-line.name{font-weight:700}
  .match .player-line .score{min-width:44px;text-align:center;border-radius:6px;padding:6px;border:1px solid #e6eefb;background:#fff}
  .match .player-line.win{background:var(--win)}
 
  .match .controls{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}

      .bracket {
      display: flex;
      justify-content: center;
      gap: 40px;
    }

    .round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      gap: 40px;
      position: relative;
    }

    .match {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 6px 10px;
      width: 200px;
      font-size: 12px;
    }

    .player-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 3px 0;
    }

    .player-line input {
      width: 26px;
      font-size: 12px;
      text-align: center;
      background: #000;
      color: #fff;
      border: 1px solid #555;
      border-radius: 3px;
      padding: 1px;
    }
 
  /* responsive */
  @media (max-width:900px){
    .bracket-tree{gap:45}
    .round{min-width:180px}
  }

  /* small helper */
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  hr{border:0;border-top:1px dashed #eee;margin:14px 0}

/* === ADDED: make bracket text white === */
.bracket-tree .match,
.bracket-tree .player-line span,
.bracket-tree .player-line input {
  color: #fff;
}

.custom-select {
  position: relative;
  width: 220px;
  font-family: sans-serif;
  cursor: pointer;
}
 

.custom-select .selected {
  margin-top: 6px;
  display: flex;
  align-items: center;
  gap: 8px;
  background: #e4e4e4;
  border: 1px solid #444;
  padding: 6px 10px;
  border-radius: 6px;
  height: 40%;
}

.custom-select .selected img {
  width: 50px;
  height: 30px;
}
 
.custom-select .options {
  position: absolute;
  top: 100%;
  left: 0;
  width: 100%;
  background: #ececec;
  border: 1px solid #444;
  border-radius: 6px;
  margin-top: 4px;
  display: none;
  z-index: 10;
}

.custom-select .options div {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
}

.custom-select .options div:hover {
  background: #333;
}

.custom-select .options img {
  width: 30px;
  height: 20px;
}

#gameIcon{
  position: absolute;
  top: 20%;
  right: 2%;
  max-width:15%;
  max-height: 10%;
}

.bracket-top8 label{
  font-size: 12px;
}
</style>
</head>
<body>
  <div class="container">
    <h1>Fighting Game Control Panel</h1>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event,'scoreboard')">üèÜ Scoreboard</button>
      <button class="tablinks" onclick="openTab(event,'commentary')">üéô Commentary</button>
      <button class="tablinks" onclick="openTab(event,'brackets')">üîÄ Brackets</button>
    </div>

    <!-- SCOREBOARD -->
    <div id="scoreboard" class="tabcontent active">
      <div class="toolbar">
        <button class="btn" onclick="updateScoreboard()">üíæ Save Scoreboard</button>
        <button class="btn" onclick="resetScoreboard()">üîÑ Reset </button>
      </div>

      <div class="settings">
        <!-- <label>Game
          <select id="game" onchange="toggleGameMode()">
            <option value="sf" data-icon="./frontend/img/game_ico/SF6_Logo.png" > Street Fighter</option>
            <option value="dbfz">Dragon Ball FighterZ</option>
            <option value="tekken">Tekken</option>
            <option value="2xko">2XKO</option>
          </select>
        </label> -->

        <!-- hidden input so toggleGameMode() still works -->
        <input type="hidden" id="game" value="sf">

        <label> Game
        <div class="custom-select" id="gameDropdown">
          <div class="selected">
            <img id="selectedGameIcon" src="./img/game_ico/SF6_Logo.png" alt=""">
            <span id="selectedGameName">Street Fighter</span>
          </div>
          <div class="options">
            <div data-value="sf" data-icon="./img/game_ico/SF6_Logo.png">
              <img  src="./img/game_ico/SF6_Logo.png" alt=""> Street Fighter
            </div>
            <div data-value="dbfz" data-icon="./img/game_ico/DBFZ_Logo.png">
              <img src="./img/game_ico/DBFZ_Logo.png"alt=""> Dragon Ball FighterZ
            </div>
            <div data-value="tekken" data-icon="./img/game_ico/Tekken_8_Logo.png">
              <img src="./img/game_ico/Tekken_8_Logo.png" alt=""> Tekken
            </div>
            <div data-value="2xko" data-icon="./img/game_ico/2XKO_Logo.png">
              <img src="./img/game_ico/2XKO_logo.png" style="height: 10px;" alt=""> 2XKO
            </div>
          </div>
        </div>
        </label>

        <label>Style
          <select id="style">
            <option value="minimalist">Minimalist</option>
            <option value="arcade">Arcade</option>
            <option value="futuristic">Futuristic</option>
          </select>
        </label>

        <label>Titlecard
          <input id="titlecard" type="text" placeholder="Top 8 / Grand Finals / etc.">
        </label>

        <img id="gameIcon" src="./img/game_ico/SF6_Logo.png " alt="Game Icon" >
      </div>

 

<div class="playerflex">
  <!-- Player 1 -->
     <div class="player-block">
       <label>Name: <input id="p1" type="text" placeholder="Player 1"></label>
       <label>Team: <input id="t1" type="text" placeholder="Team 1"></label>
       <label>Controller:
         <select id="c1">
           <option value="">None</option>
           <option value="arcade">Arcade Stick</option>
           <option value="leverless">Leverless</option>
           <option value="gamepad">Gamepad</option>
           <option value="arcade_white">Arcade Stick White</option>
           <option value="leverless_white">Leverless White</option>
           <option value="gamepad_white">Gamepad White</option>
         </select>
       </label>
       <label>Score: <input id="s1" type="number" value="0"></label>
     </div>
 
     <!-- Player 2 -->
     <div class="player-block">
       <label>Name: <input id="p2" type="text" placeholder="Player 2"></label>
       <label>Team: <input id="t2" type="text" placeholder="Team 2"></label>
       <label>Controller:
         <select id="c2">
           <option value="">None</option>
           <option value="arcade">Arcade Stick</option>
           <option value="leverless">Leverless</option>
           <option value="gamepad">Gamepad</option>
           <option value="arcade_white">Arcade Stick White</option>
           <option value="leverless_white">Leverless White</option>
           <option value="gamepad_white">Gamepad White</option>
         </select>
       </label>
       <label>Score: <input id="s2" type="number" value="0"></label>
     </div>
 
     <!-- Player 3 (2XKO only) -->
     <div class="player-block" id="p3block" style="display:none;">
       <span class="checkbox-label">
         <input type="checkbox" id="v3"> Visible
       </span>
       <label>Name: <input id="p3" type="text" placeholder="Player 3"></label>
       <label>Team: <input id="t3" type="text" placeholder="Team 3"></label>
       <label>Controller:
         <select id="c3">
           <option value="">None</option>
           <option value="arcade">Arcade Stick</option>
           <option value="leverless">Leverless</option>
           <option value="gamepad">Gamepad</option>
           <option value="arcade_white">Arcade Stick White</option>
           <option value="leverless_white">Leverless White</option>
           <option value="gamepad_white">Gamepad White</option>
         </select>
       </label>
       <label>Score: <input id="s3" type="number" value="0"></label>
     </div>
 
     <!-- Player 4 (2XKO only) -->
     <div class="player-block" id="p4block" style="display:none;">
       <span class="checkbox-label">
         <input type="checkbox" id="v4"> Visible
       </span>
       <label>Name: <input id="p4" type="text" placeholder="Player 4"></label>
       <label>Team: <input id="t4" type="text" placeholder="Team 4"></label>
       <label>Controller:
         <select id="c4">
           <option value="">None</option>
           <option value="arcade">Arcade Stick</option>
           <option value="leverless">Leverless</option>
           <option value="gamepad">Gamepad</option>
           <option value="arcade_white">Arcade Stick White</option>
           <option value="leverless_white">Leverless White</option>
           <option value="gamepad_white">Gamepad White</option>
         </select>
       </label>
       <label>Score: <input id="s4" type="number" value="0"></label>
     </div>
</div>
      <div class="small">* Player 3 and Player 4 are only used in 2XKO mode.</div>
  </div> <!-- end scoreboard tab -->

    <!-- COMMENTARY -->
    <div id="commentary" class="tabcontent">
      <div class="commentary-panel">
 
        <div class="commentator-block">
          <label>Commentator 1 - Name<input id="com1_name" type="text" placeholder="Commentator 1"></label>
          <label>Commentator 1 - Description<input id="com1_desc" type="text" placeholder="FGC Expert"></label>
        </div>

        <div class="commentator-block">
          <label>Commentator 2 - Name<input id="com2_name" type="text" placeholder="Commentator 2"></label>
          <label>Commentator 2 - Description<input id="com2_desc" type="text" placeholder="Studio Host"></label>
        </div>

        <div class="commentary-toolbar">
          <button class="btn" onclick="updateCommentary()">üíæ Save Commentary</button>
          <button class="btn" onclick="resetCommentary()">üîÑ Reset </button>
          <button class="btn" onclick="toggleCommentary(true)">‚ñ∂ Show</button>
          <button class="btn" onclick="toggleCommentary(false)">‚èπ Hide</button>
        </div>
      </div>
    </div>

    <!-- BRACKETS -->
    <div id="brackets" class="tabcontent">
      <div class="bracket-panel">
        <!-- <h2 style="margin-top:0">Brackets ‚Äî Single Elimination (Top 8)</h2> -->
        <div class="inner-tabs" style="margin-bottom:14px">
          <button id="singleTabBtn" class="active" onclick="openInnerTab('single')">Single Elimination</button>
          <button id="doubleTabBtn" onclick="openInnerTab('double')">Double Elimination</button>
        </div>

        <!-- Single elimination UI (will be loaded from bracket_single.html) -->
        <div id="single" class="inner-tabcontent" style="display:block"></div>

        <!-- Double elimination UI (will be loaded from bracket_double.html) -->
        <div id="double" class="inner-tabcontent" style="display:none"></div>
  </div>

 
<script>
/* ---------------------
   Utility + tabs
   --------------------- */
function openTab(evt, tabName){
  document.querySelectorAll(".tabcontent").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(".tablinks").forEach(el=>el.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  evt.currentTarget.classList.add("active");
}

function openInnerTab(name){
  document.querySelectorAll(".inner-tabcontent").forEach(el=>el.style.display="none");
  document.querySelectorAll(".inner-tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(name).style.display="block";
  document.getElementById(name + "TabBtn") && document.getElementById(name + "TabBtn").classList.add("active");
}

/* ---------------------
   Scoreboard logic (unchanged)
   --------------------- */
function toggleGameMode(){
  const game = document.getElementById("game").value;
  const p3 = document.getElementById("p3block");
  const p4 = document.getElementById("p4block");

  if(p3) p3.style.display = (game==="2xko") ? "flex" : "none";
  if(p4) p4.style.display = (game==="2xko") ? "flex" : "none";
}

// Custom dropdown logic
document.addEventListener("DOMContentLoaded", () => {
  const dropdown = document.getElementById("gameDropdown");
  const selected = dropdown.querySelector(".selected");
  const options = dropdown.querySelector(".options");
  const hiddenInput = document.getElementById("game");
  
  hiddenInput.type = "hidden";
  hiddenInput.id = "game";
  hiddenInput.value = "sf"; // default game
  document.body.appendChild(hiddenInput);

  selected.addEventListener("click", () => {
    options.style.display = options.style.display === "block" ? "none" : "block";
  });

  options.querySelectorAll("div").forEach(opt => {
    opt.addEventListener("click", () => {
      const val = opt.getAttribute("data-value");
      const icon = opt.getAttribute("data-icon");
      const text = opt.innerText;

      hiddenInput.value = val;
      selected.querySelector("img").src = icon;
      selected.querySelector("span").textContent = text;

      // update selected block (img + span)
      document.getElementById("selectedGameIcon").src = icon;
      document.getElementById("selectedGameName").textContent = text;
      document.getElementById("gameIcon").src = icon;

      // close dropdown
      gameDropdown.classList.remove("open");

      options.style.display = "none";

      //Call existing Logic
      toggleGameMode();
    });
  });

  // Close dropdown when clicking outside
  document.addEventListener("click", (e) => {
    if(!dropdown.contains(e.target)) options.style.display = "none";
  });
});


async function updateScoreboard(){
  const data = {
    game: document.getElementById("game").value,
    style: document.getElementById("style").value,
    titlecard: document.getElementById("titlecard").value,
    player1: document.getElementById("p1").value,
    team1: document.getElementById("t1").value,
    controller1: document.getElementById("c1").value,
    score1: parseInt(document.getElementById("s1").value||0,10),
    player2: document.getElementById("p2").value,
    team2: document.getElementById("t2").value,
    controller2: document.getElementById("c2").value,
    score2: parseInt(document.getElementById("s2").value||0,10),
    player3: document.getElementById("p3")?.value||"",
    team3: document.getElementById("t3")?.value||"",
    controller3: document.getElementById("c3")?.value||"",
    score3: parseInt(document.getElementById("s3")?.value||0,10),
    visible3: document.getElementById("v3")?.checked??false,
    player4: document.getElementById("p4")?.value||"",
    team4: document.getElementById("t4")?.value||"",
    controller4: document.getElementById("c4")?.value||"",
    score4: parseInt(document.getElementById("s4")?.value||0,10),
    visible4: document.getElementById("v4")?.checked??false
  };
  try{
    await window.go.main.App.SaveScoreboardJSON(data);
  }catch(err){
    console.error("SaveScoreboardJSON failed:",err);
    alert("Error saving scoreboard JSON (see console).");
  }
}

function resetScoreboard(){
  // limit reset to scoreboard form inputs only (avoid wiping bracket seeds by accident)
  const selectors = ['#p1','#t1','#s1','#c1','#p2','#t2','#s2','#c2','#p3','#t3','#s3','#c3','#p4','#t4','#s4','#c4','#titlecard'];
  selectors.forEach(sel=>{ const el = document.querySelector(sel); if(el) el.value = (el.type==='number')?0:''; });
  const v3 = document.getElementById("v3"), v4 = document.getElementById("v4");
  if(v3) v3.checked=false; if(v4) v4.checked=false;
  updateScoreboard();
}

/* ---------------------
   Commentary logic (unchanged behavior)
   --------------------- */
let commentaryVisible = false;

async function updateCommentary(){
  const data = {
    commentator1: document.getElementById("com1_name").value || "",
    description1: document.getElementById("com1_desc").value || "",
    commentator2: document.getElementById("com2_name").value || "",
    description2: document.getElementById("com2_desc").value || "",
    visible: commentaryVisible
  };
  try {
    if (window.go?.main?.App?.SaveCommentaryJSON) {
      await window.go.main.App.SaveCommentaryJSON(data);
    }
  } catch (e) {
    alert("Failed to save commentary: " + e);
  }
}

function resetCommentary(){
  document.getElementById("com1_name").value="";
  document.getElementById("com1_desc").value="";
  document.getElementById("com2_name").value="";
  document.getElementById("com2_desc").value="";
  updateCommentary();
}

async function toggleCommentary(show) {
  commentaryVisible = show;
  const card = document.getElementById("commentary-card");

  if (card) {
    if (show) {
      card.classList.remove("hide");
      card.classList.add("show");
    } else {
      card.classList.remove("show");
      card.classList.add("hide");
    }
  }

  const data = {
    commentator1: document.getElementById("com1_name").value||"",
    description1: document.getElementById("com1_desc").value||"",
    commentator2: document.getElementById("com2_name").value||"",
    description2: document.getElementById("com2_desc").value||"",
    visible: show
  };
  try{
    await window.go.main.App.SaveCommentaryJSON(data);
  }catch(err){
    console.error("SaveCommentaryJSON failed:",err);
  }
}

/* ---------------------
   Bracket data & functions (keeps previous IDs/logic)
   --------------------- */

let bracketData = null;

function ensureBracket(){
  if(!bracketData){
    bracketData = { single: { players: Array(8).fill(""), scores: {}, winners: {} }, double: { players: Array(8).fill(""), scores: {}, winners:{}, meta:{} } };
  }
}

async function loadBracket(){
  ensureBracket();
  try{
    const resp = await fetch("bracket.json?_=" + Date.now());
    if(!resp.ok) throw new Error("no bracket.json");
    const data = await resp.json();
    bracketData = data;
  }catch(err){
    console.warn("No bracket.json found ‚Äì using blank bracket");
  }
  renderSingleFromData();
  renderDoubleFromData();
}

{
/* ---------- replaced: renderSingleFromData, updateBracket, attachBracketListeners ---------- */

/* small helpers used by bracket logic */
function getNum(id){
  const el = document.getElementById(id);
  if(!el) return null;
  const v = el.value;
  return (v === '' || v === undefined) ? null : Number(v);
}
function setText(id, txt){
  const el = document.getElementById(id);
  if(!el) return;
  el.textContent = txt;
}
function setInputVal(id, v){
  const el = document.getElementById(id);
  if(!el) return;
  el.value = (v === null || v === undefined) ? '' : v;
}

/* compute winner from stored scores if available, else null */
function computeWinnerFromScores(scoresObj, matchId, p1Id, p2Id){
  const sc = (scoresObj && scoresObj[matchId]) ? scoresObj[matchId] : [null, null];
  if(!Array.isArray(sc) || sc.length < 2) return null;
  const [a,b] = sc;
  if(a === null || b === null || a === b) return null;
  return a > b ? (document.getElementById(p1Id)?.textContent || '') : (document.getElementById(p2Id)?.textContent || '');
}

/* render single-elim data into the UI (seeds, scores, derived winners) */
function renderSingleFromData(){
  ensureBracket();
  const s = bracketData && bracketData.single ? bracketData.single : { players: Array(8).fill(""), scores:{}, winners:{} };
  const players = s.players || Array(8).fill("");

  // seeding -> QF mapping (keep your original mapping)
  const qfPairs = {
    qf1: [players[0]||"", players[7]||""], // 1 vs 8
    qf2: [players[3]||"", players[4]||""], // 4 vs 5
    qf3: [players[2]||"", players[5]||""], // 3 vs 6
    qf4: [players[1]||"", players[6]||""]  // 2 vs 7
  };

  // fill QF names and scores
  Object.keys(qfPairs).forEach(k=>{
    const [aName,bName] = qfPairs[k];
    setText(k + 'p1', aName || '‚Äî');
    setText(k + 'p2', bName || '‚Äî');
    const sc = (s.scores && s.scores[k]) ? s.scores[k] : [null,null];
    setInputVal(k + 's1', sc[0] ?? '');
    setInputVal(k + 's2', sc[1] ?? '');
  });

  // derive QF winners (try saved winners first, otherwise compute from scores)
  ['qf1','qf2','qf3','qf4'].forEach((qf, idx) => {
    const saved = s.winners && s.winners[qf];
    const derived = saved || computeWinnerFromScores(s.scores, qf, qf + 'p1', qf + 'p2');
    // place into SF slots (mapping preserved from original logic)
    const sfTarget = (qf === 'qf1') ? 'sf1p1' : (qf === 'qf2') ? 'sf1p2' : (qf === 'qf3') ? 'sf2p1' : 'sf2p2';
    setText(sfTarget, derived || ('Winner ' + qf.toUpperCase()));
    if(derived) bracketData.single.winners = bracketData.single.winners || {}, bracketData.single.winners[qf] = derived;
    else if(bracketData.single && bracketData.single.winners) delete bracketData.single.winners[qf];
  });

  // populate SF scores
  setInputVal('sf1s1', s.scores?.sf1 ? s.scores.sf1[0] ?? '' : '');
  setInputVal('sf1s2', s.scores?.sf1 ? s.scores.sf1[1] ?? '' : '');
  setInputVal('sf2s1', s.scores?.sf2 ? s.scores.sf2[0] ?? '' : '');
  setInputVal('sf2s2', s.scores?.sf2 ? s.scores.sf2[1] ?? '' : '');

  // derive SF winners -> final participants
  ['sf1','sf2'].forEach(sf=>{
    const saved = s.winners && s.winners[sf];
    const derived = saved || computeWinnerFromScores(s.scores, sf, sf + 'p1', sf + 'p2');
    const fTarget = (sf === 'sf1') ? 'f1p1' : 'f1p2';
    setText(fTarget, derived || ('Winner ' + sf.toUpperCase()));
    if(derived) bracketData.single.winners = bracketData.single.winners || {}, bracketData.single.winners[sf] = derived;
    else if(bracketData.single && bracketData.single.winners) delete bracketData.single.winners[sf];
  });

  // final scores
  setInputVal('f1s1', s.scores?.f1 ? s.scores.f1[0] ?? '' : '');
  setInputVal('f1s2', s.scores?.f1 ? s.scores.f1[1] ?? '' : '');

  // visual highlight
  highlightWinners(bracketData.single);
}

/* unified match processor for live UI changes -> updates bracketData and downstream slots */
function processAndAdvance(){
  ensureBracket();
  bracketData.single.scores = bracketData.single.scores || {};

  // helper to update a match's scores into bracketData
  function storeScores(mid){
    const a = getNum(mid + 's1'), b = getNum(mid + 's2');
    bracketData.single.scores[mid] = [a,b];
    return [a,b];
  }

  // process QFs -> SF slots
  [['qf1','sf1p1'], ['qf2','sf1p2'], ['qf3','sf2p1'], ['qf4','sf2p2']].forEach(([mid, sfTarget])=>{
    const [a,b] = storeScores(mid);
    if(a !== null && b !== null && a !== b){
      const winner = a > b ? document.getElementById(mid + 'p1').textContent : document.getElementById(mid + 'p2').textContent;
      setText(sfTarget, winner);
      bracketData.single.winners = bracketData.single.winners || {};
      bracketData.single.winners[mid] = winner;
    } else {
      setText(sfTarget, 'Winner ' + mid.toUpperCase());
      if(bracketData.single && bracketData.single.winners) delete bracketData.single.winners[mid];
    }
  });

  // process SFs -> Final slots
  [['sf1','f1p1'], ['sf2','f1p2']].forEach(([mid, fTarget])=>{
    const [a,b] = storeScores(mid);
    if(a !== null && b !== null && a !== b){
      const winner = a > b ? document.getElementById(mid + 'p1').textContent : document.getElementById(mid + 'p2').textContent;
      setText(fTarget, winner);
      bracketData.single.winners = bracketData.single.winners || {};
      bracketData.single.winners[mid] = winner;
    } else {
      setText(fTarget, 'Winner ' + mid.toUpperCase());
      if(bracketData.single && bracketData.single.winners) delete bracketData.single.winners[mid];
    }
  });

  // final scores stored
  storeScores('f1');

  // update visual highlights
  highlightWinners(bracketData.single);

  // optionally persist (non-blocking)
  try{ if(window.go?.main?.App) window.go.main.App.SaveBracketJSON(bracketData); }catch(e){}
}

/* attach listeners to inputs inside the visual bracket only */
function attachBracketListeners(){
  const container = document.getElementById('visualBracket') || document;
  const inputs = container.querySelectorAll('input[type=number]');
  inputs.forEach(inp=>{
    inp.removeEventListener('input', processAndAdvance);
    inp.addEventListener('input', processAndAdvance);
  });
}

/* ---------- end replacements ---------- */
}

function renderDoubleFromData(){
  ensureBracket();
  const d = bracketData.double || { players: Array(8).fill("") };
  for(let i=1;i<=8;i++){
    const el = document.getElementById("dp"+i);
    if(el) el.value = (d.players && d.players[i-1]) ? d.players[i-1] : "";
  }
}

async function saveDoublePlayers(){
  ensureBracket();

  // read seed inputs dp1..dp8
  const arr = [
    document.getElementById("dp1")?.value || "",
    document.getElementById("dp2")?.value || "",
    document.getElementById("dp3")?.value || "",
    document.getElementById("dp4")?.value || "",
    document.getElementById("dp5")?.value || "",
    document.getElementById("dp6")?.value || "",
    document.getElementById("dp7")?.value || "",
    document.getElementById("dp8")?.value || ""
  ];

  // persist player seeds in bracketData.double
  bracketData.double = bracketData.double || {};
  bracketData.double.players = arr;
  bracketData.double.scores = bracketData.double.scores || {};
  bracketData.double.winners = bracketData.double.winners || {};

  try{
    await saveBracket(); // uses existing saveBracket() which saves bracketData
  }catch(err){
    console.warn("saveBracket failed:", err);
  }

  // mapping as requested:
  // dp1 -> wb_sf1_p1, dp2 -> wb_sf1_p2, dp3 -> wb_sf2_p1, dp4 -> wb_sf2_p2
  // dp5 -> lb_r1_m1_p1, dp6 -> lb_r1_m1_p2, dp7 -> lb_r1_m2_p1, dp8 -> lb_r1_m2_p2
  const set = (id, value) => {
    const el = document.getElementById(id);
    if(el){
      // prefer textContent for spans, if input exist set value
      if(el.tagName === 'INPUT') el.value = value;
      else el.textContent = value || '';
    }
  };

  set('wb_sf1_p1', arr[0] || 'Seed 1');
  set('wb_sf1_p2', arr[1] || 'Seed 2');
  set('wb_sf2_p1', arr[2] || 'Seed 3');
  set('wb_sf2_p2', arr[3] || 'Seed 4');

  set('lb_r1_m1_p1', arr[4] || 'Loser 1');
  set('lb_r1_m1_p2', arr[5] || 'Loser 2');
  set('lb_r1_m2_p1', arr[6] || 'Loser 3');
  set('lb_r1_m2_p2', arr[7] || 'Loser 4');

  // clear numeric inputs inside the double visual so new progression is clean
  document.querySelectorAll('#doubleVisual input[type="number"]').forEach(i=>i.value='');

  // reset downstream placeholders
  const placeholders = {
    'wb_final_p1': 'Winner SF1', 'wb_final_p2':'Winner SF2',
    'lb_r2_m1_p1':'Winner R1M1','lb_r2_m1_p2':'Loser SF1',
    'lb_r2_m2_p1':'Winner R1M2','lb_r2_m2_p2':'Loser SF2',
    'lb_final_p1':'Winner R2M1','lb_final_p2':'Winner R2M2',
    'gf_wb':'WB Winner','gf_lb':'LB Winner'
  };
  Object.entries(placeholders).forEach(([id,val])=> set(id, val));

  // hide gf reset area
  const gfReset = document.getElementById('gf_reset');
  if(gfReset) gfReset.style.display = 'none';

  // run progression
  if(typeof updateDoubleBracket === 'function') updateDoubleBracket();
}


function resetDouble(){
  // clear seed inputs dp1..dp8
  for(let i=1;i<=8;i++){
    const el = document.getElementById('dp'+i);
    if(el) el.value = '';
  }

  // clear bracketData.double and persist
  bracketData.double = { players: Array(8).fill(""), scores: {}, winners: {} };
  try{ saveBracket(); }catch(e){ console.warn('saveBracket failed', e); }

  // reset visual placeholders and clear numeric inputs
  const resetPlace = (id, val) => {
    const el = document.getElementById(id);
    if(el){
      if(el.tagName === 'INPUT') el.value = '';
      else el.textContent = val || '';
    }
  };

  resetPlace('wb_sf1_p1','Winner QF1'); resetPlace('wb_sf1_p2','Winner QF2');
  resetPlace('wb_sf2_p1','Winner QF3'); resetPlace('wb_sf2_p2','Winner QF4');

  resetPlace('lb_r1_m1_p1','Loser QF1'); resetPlace('lb_r1_m1_p2','Loser QF2');
  resetPlace('lb_r1_m2_p1','Loser QF3'); resetPlace('lb_r1_m2_p2','Loser QF4');

  resetPlace('wb_final_p1','Winner SF1'); resetPlace('wb_final_p2','Winner SF2');
  resetPlace('lb_r2_m1_p1','Winner R1M1'); resetPlace('lb_r2_m1_p2','Loser SF1');
  resetPlace('lb_r2_m2_p1','Winner R1M2'); resetPlace('lb_r2_m2_p2','Loser SF2');
  resetPlace('lb_final_p1','Winner R2M1'); resetPlace('lb_final_p2','Winner R2M2');
  resetPlace('gf_wb','WB Winner'); resetPlace('gf_lb','LB Winner');

  document.querySelectorAll('#doubleVisual input[type="number"]').forEach(i=>i.value='');

  // hide reset UI
  const gfReset = document.getElementById('gf_reset'); if(gfReset) gfReset.style.display='none';

  // re-run progression to clear state
  if(typeof updateDoubleBracket === 'function') updateDoubleBracket();
}
/* ---------------------
   Initialization
   --------------------- */
ensureBracket();
loadBracket();
</script>

<script>
function seedPlayers(){
  document.getElementById("wb_sf1p1").textContent=document.getElementById("sp1").value;
  document.getElementById("wb_sf1p2").textContent=document.getElementById("sp8").value;
  document.getElementById("wb_sf2p1").textContent=document.getElementById("sp4").value;
  document.getElementById("wb_sf2p2").textContent=document.getElementById("sp5").value;
  document.getElementById("wb_sf3p1").textContent=document.getElementById("sp3").value;
  document.getElementById("wb_sf3p2").textContent=document.getElementById("sp6").value;
  document.getElementById("wb_sf4p1").textContent=document.getElementById("sp2").value;
  document.getElementById("wb_sf4p2").textContent=document.getElementById("sp7").value;
}

function setMatch(matchId, nextWinId, nextLoseId){
  let p1=document.getElementById(matchId+"p1").textContent;
  let p2=document.getElementById(matchId+"p2").textContent;
  let s1=parseInt(document.getElementById(matchId+"s1").value)||0;
  let s2=parseInt(document.getElementById(matchId+"s2").value)||0;
  let winner=s1>s2?p1:p2;
  let loser=s1>s2?p2:p1;

  if(nextWinId){
    let slot=document.querySelector("#"+nextWinId+" span:empty, #"+nextWinId+" span:contains('Winner')");
    if(slot) slot.textContent=winner;
  }
  if(nextLoseId){
    let slot=document.querySelector("#"+nextLoseId+" span:empty, #"+nextLoseId+" span:contains('L ')");
    if(slot) slot.textContent=loser;
  }
}

function setGrandFinal(){
  let p1=document.getElementById("gfp1").textContent;
  let p2=document.getElementById("gfp2").textContent;
  let s1=parseInt(document.getElementById("gfs1").value)||0;
  let s2=parseInt(document.getElementById("gfs2").value)||0;
  if(s1>s2){
    alert("üèÜ Champion: "+p1);
  } else if(s2>s1){
    // LB Champ won, trigger reset
    document.getElementById("gf_reset").style.display="block";
    document.getElementById("gf_resetp1").textContent=p1;
    document.getElementById("gf_resetp2").textContent=p2;
  }
}

function finalizeChampion(){
  let p1=document.getElementById("gf_resetp1").textContent;
  let p2=document.getElementById("gf_resetp2").textContent;
  let s1=parseInt(document.getElementById("gf_resets1").value)||0;
  let s2=parseInt(document.getElementById("gf_resets2").value)||0;
  let champ=s1>s2?p1:p2;
  alert("üèÜ Champion: "+champ);
}
</script>


<script>
  // loadPartial: fetch HTML partial and inject into container
  async function loadPartial(containerId, filePath){
    try{
      const res = await fetch(filePath + '?_=' + Date.now());
      if(!res.ok) throw new Error('Failed to load ' + filePath);
      const html = await res.text();
      const container = document.getElementById(containerId);
      if(container) container.innerHTML = html;

      // re-attach bracket listeners if visual was injected
      attachBracketListeners();

      // call init hooks if present in the injected partial
      if(containerId === 'single' && typeof initSingle === 'function') initSingle();
      if(containerId === 'double' && typeof initDouble === 'function') initDouble();
    }catch(err){
      console.warn('loadPartial error:', filePath, err);
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // load partials using new filenames to avoid conflicts with your existing single.html / double.html
    loadPartial('single','bracket_single.html');
    loadPartial('double','bracket_double.html');

    // existing init
    attachBracketListeners();
  });
</script>

<!-- index.html (only showing bottom part where scripts are) -->

<script>
/* ----------------- SINGLE BRACKET LOGIC (unchanged) ----------------- */
 function getSingleSeedInputs() {
  return [
    document.getElementById("sp1")?.value || "",
    document.getElementById("sp8")?.value || "",
    document.getElementById("sp4")?.value || "",
    document.getElementById("sp5")?.value || "",
    document.getElementById("sp3")?.value || "",
    document.getElementById("sp6")?.value || "",
    document.getElementById("sp2")?.value || "",
    document.getElementById("sp7")?.value || ""
  ];
}

function setSingleSeedInputs(arr) {
  if (!arr) return;
  document.getElementById("sp1").value = arr[0] || "";
  document.getElementById("sp8").value = arr[1] || "";
  document.getElementById("sp4").value = arr[2] || "";
  document.getElementById("sp5").value = arr[3] || "";
  document.getElementById("sp3").value = arr[4] || "";
  document.getElementById("sp6").value = arr[5] || "";
  document.getElementById("sp2").value = arr[6] || "";
  document.getElementById("sp7").value = arr[7] || "";
}

// --- Save/Reset Single Players ---
async function saveSinglePlayers() {
  ensureBracket();
  const arr = getSingleSeedInputs();
  bracketData.single.players = arr;
  bracketData.single.scores = bracketData.single.scores || {};
  bracketData.single.winners = bracketData.single.winners || {};
  try {
    if (typeof saveBracket === "function") await saveBracket();
    else if (window.go?.main?.App) await window.go.main.App.SaveBracketJSON(bracketData);
  } catch (e) {
    console.warn("saveBracket failed", e);
  }
  seedSingleVisualBracket();
}

function resetSingle() {
  setSingleSeedInputs(Array(8).fill(""));
  bracketData.single = { players: Array(8).fill(""), scores: {}, winners: {} };
  seedSingleVisualBracket();
  try {
    if (typeof saveBracket === "function") saveBracket();
    else if (window.go?.main?.App) window.go.main.App.SaveBracketJSON(bracketData);
  } catch (e) {
    console.warn("saveBracket failed", e);
  }
}

// --- Seeding and Progression ---
function seedSingleVisualBracket() {
  const seeds = getSingleSeedInputs();
  // QF mapping: qf1: 1 vs 8, qf2: 4 vs 5, qf3: 3 vs 6, qf4: 2 vs 7
  setText("qf1p1", seeds[0] || "Seed 1");
  setText("qf1p2", seeds[1] || "Seed 8");
  setText("qf2p1", seeds[2] || "Seed 4");
  setText("qf2p2", seeds[3] || "Seed 5");
  setText("qf3p1", seeds[4] || "Seed 3");
  setText("qf3p2", seeds[5] || "Seed 6");
  setText("qf4p1", seeds[6] || "Seed 2");
  setText("qf4p2", seeds[7] || "Seed 7");

  // Reset downstream
  setText("sf1p1", "Winner QF1");
  setText("sf1p2", "Winner QF2");
  setText("sf2p1", "Winner QF3");
  setText("sf2p2", "Winner QF4");
  setText("f1p1", "Winner SF1");
  setText("f1p2", "Winner SF2");

  // Clear all score inputs
  document.querySelectorAll('#visualBracket input[type=number]').forEach(i => i.value = '');

  // Run progression
  renderSingleFromData();
}

// --- Render/Progression Logic ---
function renderSingleFromData() {
  ensureBracket();
  const s = bracketData.single || { players: Array(8).fill(""), scores: {}, winners: {} };
  const players = s.players || Array(8).fill("");

  // QF mapping
  const qfPairs = {
    qf1: [players[0] || "", players[1] || ""],
    qf2: [players[2] || "", players[3] || ""],
    qf3: [players[4] || "", players[5] || ""],
    qf4: [players[6] || "", players[7] || ""]
  };

  Object.keys(qfPairs).forEach(k => {
    const [aName, bName] = qfPairs[k];
    setText(k + "p1", aName || "‚Äî");
    setText(k + "p2", bName || "‚Äî");
    const sc = (s.scores && s.scores[k]) ? s.scores[k] : [null, null];
    setInputVal(k + "s1", sc[0] != null ? sc[0] : "");
    setInputVal(k + "s2", sc[1] != null ? sc[1] : "");
  });

  // QF winners
  const qfWinners = {};
  ["qf1", "qf2", "qf3", "qf4"].forEach(qf => {
    const sc = s.scores?.[qf];
    if (Array.isArray(sc) && sc.length >= 2 && sc[0] !== null && sc[1] !== null && sc[0] !== sc[1]) {
      const winner = sc[0] > sc[1] ? document.getElementById(qf + "p1").textContent : document.getElementById(qf + "p2").textContent;
      qfWinners[qf] = winner;
    }
  });

  setText("sf1p1", qfWinners.qf1 || "Winner QF1");
  setText("sf1p2", qfWinners.qf2 || "Winner QF2");
  setText("sf2p1", qfWinners.qf3 || "Winner QF3");
  setText("sf2p2", qfWinners.qf4 || "Winner QF4");

  // SF scores
  setInputVal("sf1s1", s.scores?.sf1 ? s.scores.sf1[0] ?? "" : "");
  setInputVal("sf1s2", s.scores?.sf1 ? s.scores.sf1[1] ?? "" : "");
  setInputVal("sf2s1", s.scores?.sf2 ? s.scores.sf2[0] ?? "" : "");
  setInputVal("sf2s2", s.scores?.sf2 ? s.scores.sf2[1] ?? "" : "");

  // SF winners
  const sfWinners = {};
  ["sf1", "sf2"].forEach(sf => {
    const sc = s.scores?.[sf];
    if (Array.isArray(sc) && sc.length >= 2 && sc[0] !== null && sc[1] !== null && sc[0] !== sc[1]) {
      const winner = sc[0] > sc[1] ? document.getElementById(sf + "p1").textContent : document.getElementById(sf + "p2").textContent;
      sfWinners[sf] = winner;
    }
  });

  setText("f1p1", sfWinners.sf1 || "Winner SF1");
  setText("f1p2", sfWinners.sf2 || "Winner SF2");

  // Final scores
  setInputVal("f1s1", s.scores?.f1 ? s.scores.f1[0] ?? "" : "");
  setInputVal("f1s2", s.scores?.f1 ? s.scores.f1[1] ?? "" : "");
}

// --- Helpers ---
function setText(id, txt) {
  const el = document.getElementById(id);
  if (el) el.textContent = txt;
}
function setInputVal(id, v) {
  const el = document.getElementById(id);
  if (el) el.value = (v === null || v === undefined) ? "" : v;
}

// --- Attach listeners (call after loading partial) ---
function attachSingleBracketListeners() {
  const container = document.getElementById('visualBracket') || document;
  const inputs = container.querySelectorAll('input[type=number]');
  inputs.forEach(inp => {
    inp.removeEventListener('input', processSingleBracket);
    inp.addEventListener('input', processSingleBracket);
  });
}

// --- Live progression ---
function processSingleBracket() {
  ensureBracket();
  bracketData.single.scores = bracketData.single.scores || {};

  // Store scores
  function storeScores(mid) {
    const a = parseInt(document.getElementById(mid + "s1").value) || 0;
    const b = parseInt(document.getElementById(mid + "s2").value) || 0;
    bracketData.single.scores[mid] = [a, b];
    return [a, b];
  }

  // QFs -> SFs
  [["qf1", "sf1p1"], ["qf2", "sf1p2"], ["qf3", "sf2p1"], ["qf4", "sf2p2"]].forEach(([mid, sfTarget]) => {
    const [a, b] = storeScores(mid);
    if (a !== null && b !== null && a !== b) {
      const winner = a > b ? document.getElementById(mid + "p1").textContent : document.getElementById(mid + "p2").textContent;
      setText(sfTarget, winner);
      bracketData.single.winners = bracketData.single.winners || {};
      bracketData.single.winners[mid] = winner;
    } else {
      setText(sfTarget, "Winner " + mid.toUpperCase());
      if (bracketData.single && bracketData.single.winners) delete bracketData.single.winners[mid];
    }
  });

  // SFs -> Final
  [["sf1", "f1p1"], ["sf2", "f1p2"]].forEach(([mid, fTarget]) => {
    const [a, b] = storeScores(mid);
    if (a !== null && b !== null && a !== b) {
      const winner = a > b ? document.getElementById(mid + "p1").textContent : document.getElementById(mid + "p2").textContent;
      setText(fTarget, winner);
      bracketData.single.winners = bracketData.single.winners || {};
      bracketData.single.winners[mid] = winner;
    } else {
      setText(fTarget, "Winner " + mid.toUpperCase());
      if (bracketData.single && bracketData.single.winners) delete bracketData.single.winners[mid];
    }
  });

  // Final scores
  storeScores("f1");

  // Optionally persist
  try {
    if (window.go?.main?.App) window.go.main.App.SaveBracketJSON(bracketData);
  } catch (e) {}
}

// --- Initialization (call after loading partial) ---
function initSingle() {
  attachSingleBracketListeners();
  setTimeout(() => { renderSingleFromData(); }, 30);
}


/* ----------------- DOUBLE BRACKET LOGIC ----------------- */

if (typeof bracketData === 'undefined') window.bracketData = {};
function ensureBracket(){
  if(!bracketData.double){
    bracketData.double = { players: Array(8).fill(""), scores:{}, winners:{}, eliminated:[] };
  }
}

/* Called when bracket_double.html is loaded */
function initDouble(){
  const container = document.getElementById('doubleVisual') || document;

  // Attach score input listeners
  const numberInputs = container.querySelectorAll('input[type=number]');
  numberInputs.forEach(i=>{
    i.removeEventListener('input', updateDoubleBracket);
    i.addEventListener('input', updateDoubleBracket);
  });

  // Attach seed listeners
  for(let i=1;i<=8;i++){
    const dp = document.getElementById('dp'+i);
    if(!dp) continue;
    dp.removeEventListener('input', seedDoubleVisualBracket);
    dp.addEventListener('input', seedDoubleVisualBracket);
  }

  setTimeout(populateDoubleFromData, 20);
  setTimeout(()=>{
    seedDoubleVisualBracket();
    updateDoubleBracket();
  }, 40);
}

function val(id){
  const el = document.getElementById(id);
  if(!el) return null;
  const v = el.value;
  return (v===''||v===undefined)?null:Number(v);
}
function text(id){
  const el = document.getElementById(id);
  return el ? (el.textContent||'').trim() : '';
}
function setText(id, value){
  const el=document.getElementById(id);
  if(!el) return;
  el.textContent=value;
  el.classList.remove('eliminated');
}
function setEliminated(id,on){
  const el=document.getElementById(id);
  if(!el) return;
  if(on) el.classList.add('eliminated'); else el.classList.remove('eliminated');
}

/* Highlight winners/losers */
function highlightDoubleWinners(){
  const matchIds=['wb_sf1','wb_sf2','wb_final','lb_r1_m1','lb_r1_m2','lb_qf_m1','lb_qf_m2','lb_final','grand_final'];
  matchIds.forEach(mid=>{
    const matchEl=document.getElementById(mid);
    if(!matchEl) return;
    const lines=matchEl.querySelectorAll('.player-line');
    lines.forEach(l=>{ l.classList.remove('win','lose'); });
    const scores=bracketData.double.scores[mid];
    if(!scores||scores.length<2) return;
    const [a,b]=scores;
    if(a===null||b===null||a===b) return;
    const winner=a>b?text(mid+'_p1'):text(mid+'_p2');
    lines.forEach(l=>{
      const span=l.querySelector('span');
      if(!span) return;
      if(span.textContent.trim()===winner) l.classList.add('win'); else l.classList.add('lose');
    });
  });
}

/* Progression */
function updateDoubleBracket(){
  ensureBracket();
  bracketData.double.eliminated=[];

  // WB Semis ‚Üí WB Final, losers ‚Üí LB QF slots
  [['wb_sf1','wb_final_p1'],['wb_sf2','wb_final_p2']].forEach(([mid,winTarget])=>{
    const a=val(mid+'_s1'), b=val(mid+'_s2');
    bracketData.double.scores[mid]=[a,b];
    if(a!==null&&b!==null&&a!==b){
      const winner=a>b?text(mid+'_p1'):text(mid+'_p2');
      const loser =a>b?text(mid+'_p2'):text(mid+'_p1');
      setText(winTarget,winner);
      bracketData.double.winners[mid]=winner;
      bracketData.double.losers=bracketData.double.losers||{};
      bracketData.double.losers[mid]=loser;
    } else {
      setText(winTarget,'Winner '+mid.toUpperCase());
      delete bracketData.double.winners[mid];
      if(bracketData.double.losers) delete bracketData.double.losers[mid];
    }
  });

  // LB R1 ‚Üí LB Quarterfinals
  [['lb_r1_m1','lb_qf_m1_p1'],['lb_r1_m2','lb_qf_m2_p1']].forEach(([mid,winTarget])=>{
    const a=val(mid+'_s1'), b=val(mid+'_s2');
    bracketData.double.scores[mid]=[a,b];
    if(a!==null&&b!==null&&a!==b){
      const winner=a>b?text(mid+'_p1'):text(mid+'_p2');
      const loser =a>b?text(mid+'_p2'):text(mid+'_p1');
      setText(winTarget,winner);
      bracketData.double.winners[mid]=winner;
      bracketData.double.eliminated.push(loser);
      if(a>b) setEliminated(mid+'_p2',true); else setEliminated(mid+'_p1',true);
    } else {
      setText(winTarget,'Winner '+mid.toUpperCase());
      setEliminated(mid+'_p1',false); setEliminated(mid+'_p2',false);
      delete bracketData.double.winners[mid];
    }
  });

  // Drop WB SF losers into LB QF
  if(bracketData.double.losers){
    if(bracketData.double.losers['wb_sf1']) setText('lb_qf_m1_p2',bracketData.double.losers['wb_sf1']);
    if(bracketData.double.losers['wb_sf2']) setText('lb_qf_m2_p2',bracketData.double.losers['wb_sf2']);
  }

  // LB QF ‚Üí LB Semifinal
  [['lb_qf_m1','lb_semi_p1'],['lb_qf_m2','lb_semi_p2']].forEach(([mid,winTarget])=>{
    const a=val(mid+'_s1'), b=val(mid+'_s2');
    bracketData.double.scores[mid]=[a,b];
    if(a!==null&&b!==null&&a!==b){
      const winner=a>b?text(mid+'_p1'):text(mid+'_p2');
      const loser =a>b?text(mid+'_p2'):text(mid+'_p1');
      setText(winTarget,winner);
      bracketData.double.winners[mid]=winner;
      bracketData.double.eliminated.push(loser);
      if(a>b) setEliminated(mid+'_p2',true); else setEliminated(mid+'_p1',true);
    } else {
      setText(winTarget,'Winner '+mid.toUpperCase());
      setEliminated(mid+'_p1',false); setEliminated(mid+'_p2',false);
      delete bracketData.double.winners[mid];
    }
  });

  // LB Semi ‚Üí LB Final (vs WB Final loser)
  const lsa=val('lb_semi_s1'), lsb=val('lb_semi_s2');
  bracketData.double.scores['lb_semi']=[lsa,lsb];
  if(lsa!==null&&lsb!==null&&lsa!==lsb){
    const winner=lsa>lsb?text('lb_semi_p1'):text('lb_semi_p2');
    const loser =lsa>lsb?text('lb_semi_p2'):text('lb_semi_p1');
    setText('lb_final_p1',winner); // Winner LB Semi
    bracketData.double.winners['lb_semi']=winner;
    bracketData.double.eliminated.push(loser);
    if(lsa>lsb) setEliminated('lb_semi_p2',true); else setEliminated('lb_semi_p1',true);
  } else {
    setText('lb_final_p1','Winner LB Semi');
    setEliminated('lb_semi_p1',false); setEliminated('lb_semi_p2',false);
    delete bracketData.double.winners['lb_semi'];
  }

  // WB Final loser ‚Üí LB Final slot
  if(bracketData.double.losers && bracketData.double.losers['wb_final']){
    setText('lb_final_p2',bracketData.double.losers['wb_final']);
  }

  // LB Final ‚Üí GF LB slot
  const lfa=val('lb_final_s1'), lfb=val('lb_final_s2');
  bracketData.double.scores['lb_final']=[lfa,lfb];
  if(lfa!==null&&lfb!==null&&lfa!==lfb){
    const winner=lfa>lfb?text('lb_final_p1'):text('lb_final_p2');
    const loser =lfa>lfb?text('lb_final_p2'):text('lb_final_p1');
    setText('gf_lb',winner);
    bracketData.double.winners['lb_final']=winner;
    bracketData.double.eliminated.push(loser);
    if(lfa>lfb) setEliminated('lb_final_p2',true); else setEliminated('lb_final_p1',true);
  } else {
    setText('gf_lb','LB Winner');
    setEliminated('lb_final_p1',false); setEliminated('lb_final_p2',false);
    delete bracketData.double.winners['lb_final'];
  }

  // WB Final ‚Üí GF WB slot
  const wfa=val('wb_final_s1'), wfb=val('wb_final_s2');
  bracketData.double.scores['wb_final']=[wfa,wfb];
  if(wfa!==null&&wfb!==null&&wfa!==wfb){
    const winner=wfa>wfb?text('wb_final_p1'):text('wb_final_p2');
    const loser =wfa>wfb?text('wb_final_p2'):text('wb_final_p1');
    setText('gf_wb',winner);
    bracketData.double.winners['wb_final']=winner;
    bracketData.double.losers=bracketData.double.losers||{};
    bracketData.double.losers['wb_final']=loser;
  } else {
    setText('gf_wb','WB Winner');
    delete bracketData.double.winners['wb_final'];
  }

  // GF ‚Üí champion or reset
  const gfa=val('gf_wb_s'), gfb=val('gf_lb_s');
  bracketData.double.scores['grand_final']=[gfa,gfb];
  if(gfa!==null&&gfb!==null&&gfa!==gfb){
    if(gfa>gfb){
      alert('üèÜ Champion: '+text('gf_wb'));
      setEliminated('gf_lb',true);
      document.getElementById('gf_reset').style.display='none';
    } else {
      document.getElementById('gf_reset').style.display='block';
      setText('gf_reset_p1',text('gf_wb'));
      setText('gf_reset_p2',text('gf_lb'));
    }
  } else {
    document.getElementById('gf_reset').style.display='none';
  }

  highlightDoubleWinners();

  try{ if(window.go?.main?.App) window.go.main.App.SaveBracketJSON(bracketData); }catch(e){}
}

/* Seeding */
function seedDoubleVisualBracket(){
  const seeds=[];
  for(let i=1;i<=8;i++) seeds.push(document.getElementById('dp'+i)?.value||'');

  setText('wb_sf1_p1',seeds[0]||'Seed 1');
  setText('wb_sf1_p2',seeds[1]||'Seed 2');
  setText('wb_sf2_p1',seeds[2]||'Seed 3');
  setText('wb_sf2_p2',seeds[3]||'Seed 4');

  setText('lb_r1_m1_p1',seeds[4]||'Seed 5');
  setText('lb_r1_m1_p2',seeds[5]||'Seed 6');
  setText('lb_r1_m2_p1',seeds[6]||'Seed 7');
  setText('lb_r1_m2_p2',seeds[7]||'Seed 8');

  document.querySelectorAll('#doubleVisual input[type=number]').forEach(i=>i.value='');
  updateDoubleBracket();
}

/* Restore */
function populateDoubleFromData(){
  ensureBracket();
  const d=bracketData.double||{players:Array(8).fill("")};
  if(d.players?.length>=8){
    for(let i=0;i<8;i++){
      const el=document.getElementById('dp'+(i+1));
      if(el) el.value=d.players[i]||'';
    }
    seedDoubleVisualBracket();
  }
  const scores=d.scores||{};
  Object.keys(scores).forEach(mid=>{
    const arr=scores[mid];
    if(!arr||arr.length!==2) return;
    if(mid==='grand_final'){
      document.getElementById('gf_wb_s').value=arr[0]??'';
      document.getElementById('gf_lb_s').value=arr[1]??'';
    } else if(mid==='gf_reset'){
      document.getElementById('gf_reset_s1').value=arr[0]??'';
      document.getElementById('gf_reset_s2').value=arr[1]??'';
    } else {
      const s1=document.getElementById(mid+'_s1'), s2=document.getElementById(mid+'_s2');
      if(s1) s1.value=arr[0]??''; if(s2) s2.value=arr[1]??'';
    }
  });
  updateDoubleBracket();
}

/* Save / Reset */
async function saveDoublePlayers(){
  ensureBracket();
  const arr=[];
  for(let i=1;i<=8;i++) arr.push(document.getElementById('dp'+i)?.value||'');
  bracketData.double.players=arr;
  try{ if(typeof saveBracket==='function') await saveBracket(); }catch(e){}
  seedDoubleVisualBracket();
}
function resetDouble(){
  for(let i=1;i<=8;i++){ const el=document.getElementById('dp'+i); if(el) el.value=''; }
  bracketData.double={players:Array(8).fill(""),scores:{},winners:{},eliminated:[]};
  seedDoubleVisualBracket();
  try{ if(typeof saveBracket==='function') saveBracket(); }catch(e){}
}

/* GF Reset */
function finalizeChampion(){
  const p1=text('gf_reset_p1'), p2=text('gf_reset_p2');
  const s1=val('gf_reset_s1'), s2=val('gf_reset_s2');
  if(s1!==null&&s2!==null&&s1!==s2){
    const champ=s1>s2?p1:p2;
    alert('üèÜ Champion: '+champ);
    bracketData.double.scores.gf_reset=[s1,s2];
    bracketData.double.winners.gf_reset=champ;
    try{ if(window.go?.main?.App) window.go.main.App.SaveBracketJSON(bracketData); }catch(e){}
    document.getElementById('gf_reset').style.display='none';
  }
}
 
</script>


</body>
</html>
