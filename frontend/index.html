<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Scoreboard Control</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{
    --bg:#f5f7fa;
    --card-bg:#fff;
    --panel:#ffffff;
    --border:#dcdfe3;
    --accent:#0077ff;
    --muted:#666;
    --text:#222;
    --win:#5a5a5a;
    --lose:#fff5f5;
  }
/* googoo */
/* gaagaa */
  html,body{height:100%;margin:0;padding:0;background:var(--bg);font-family:Inter, Arial, sans-serif;color:var(--text)}
  .container{padding:20px;max-width:1200px;margin:0 auto}
  h1{margin:0 0 18px;font-size:20px;color:var(--accent)}

  /* Top tabs */
  .tab{display:flex;gap:10px;border-bottom:2px solid var(--border);margin-bottom:18px}
  .tab button{background:none;border:0;padding:10px 14px;cursor:pointer;font-weight:700;border-radius:6px;color:var(--text)}
  .tab button.active{background:var(--accent);color:#fff}
  .tabcontent{display:none}
  .tabcontent.active{display:block}

  /* toolbar & controls */
  .toolbar{display:flex;gap:10px;margin-bottom:18px}
  button.btn{background:var(--accent);color:#fff;border:0;padding:8px 12px;border-radius:8px;cursor:pointer}
  button.btn:hover{filter:brightness(.9)}
  .settings{display:flex;gap:18px;flex-wrap:wrap;margin-bottom:18px}
  .settings label{display:flex;flex-direction:column;font-weight:700;font-size:13px}
  input[type="text"], input[type="number"], select{margin-top:6px;padding:8px;border:1px solid var(--border);border-radius:6px;min-width:26px}

  .player-block{background:var(--card-bg);border:1px solid var(--border);border-radius:10px;padding:12px;margin-bottom:12px;display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .player-block label{font-weight:700;font-size:13px;min-width:150px}

  /* commentary */
  .commentary-panel{padding:14px;background:var(--panel);border:1px solid var(--border);border-radius:10px}
  .commentator-block{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
  .commentary-toolbar{display:flex;gap:8px;margin-top:6px}

  /* Bracket Panel layout (horizontal tournament tree) */
  .bracket-panel{padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:10px}
  .inner-tabs{display:flex;gap:10px;margin-bottom:14px}
  .inner-tabs button{background:none;border:1px solid var(--border);padding:8px 10px;border-radius:8px;cursor:pointer}
  .inner-tabs button.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  .round{display:flex;flex-direction:column;gap:18px;min-width:220px}
  .round .round-title{text-align:center;font-weight:800;color:var(--muted);margin-bottom:6px}
  
  .match{width: 240px;display: table; background:#f8fbff;border:1px solid var(--border);border-radius:8px;padding:8px 10px;position:relative;box-shadow:0 4px 10px rgba(0,0,0,0.03)}
  .match .player-line{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px;border-radius:6px}
  .match .player-line.name{font-weight:700}
  .match .player-line .score{min-width:44px;text-align:center;border-radius:6px;padding:6px;border:1px solid #e6eefb;background:#fff}
  .match .player-line.win{background:var(--win)}
 
  .match .controls{display:flex;gap:8px;margin-top:8px;justify-content:flex-end}

      .bracket {
      display: flex;
      justify-content: center;
      gap: 40px;
    }

    .round {
      display: flex;
      flex-direction: column;
      justify-content: space-around;
      gap: 40px;
      position: relative;
    }

    .match {
      background: #222;
      border: 1px solid #444;
      border-radius: 6px;
      padding: 6px 10px;
      width: 200px;
      font-size: 12px;
    }

    .player-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 3px 0;
    }

    .player-line input {
      width: 26px;
      font-size: 12px;
      text-align: center;
      background: #000;
      color: #fff;
      border: 1px solid #555;
      border-radius: 3px;
      padding: 1px;
    }
 
  /* responsive */
  @media (max-width:900px){
    .bracket-tree{gap:45}
    .round{min-width:180px}
  }

  /* small helper */
  .small{font-size:12px;color:var(--muted);margin-top:8px}
  hr{border:0;border-top:1px dashed #eee;margin:14px 0}

/* === ADDED: make bracket text white === */
.bracket-tree .match,
.bracket-tree .player-line span,
.bracket-tree .player-line input {
  color: #fff;
}
</style>
</head>
<body>
  <div class="container">
    <h1>Fighting Game Control Panel</h1>

    <div class="tab">
      <button class="tablinks active" onclick="openTab(event,'scoreboard')">üèÜ Scoreboard</button>
      <button class="tablinks" onclick="openTab(event,'commentary')">üéô Commentary</button>
      <button class="tablinks" onclick="openTab(event,'brackets')">üîÄ Brackets</button>
    </div>

    <!-- SCOREBOARD -->
    <div id="scoreboard" class="tabcontent active">
      <div class="toolbar">
        <button class="btn" onclick="updateScoreboard()">üíæ Save Scoreboard</button>
        <button class="btn" onclick="resetScoreboard()">üîÑ Reset Scoreboard</button>
      </div>

      <div class="settings">
        <label>Game
          <select id="game" onchange="toggleGameMode()">
            <option value="sf">Street Fighter</option>
            <option value="dbfz">Dragon Ball FighterZ</option>
            <option value="tekken">Tekken</option>
            <option value="2xko">2XKO</option>
          </select>
        </label>

        <label>Style
          <select id="style">
            <option value="minimalist">Minimalist</option>
            <option value="arcade">Arcade</option>
            <option value="futuristic">Futuristic</option>
          </select>
        </label>

        <label>Titlecard
          <input id="titlecard" type="text" placeholder="Top 8 / Grand Finals / etc.">
        </label>
      </div>

 <!-- Player 1 -->
    <div class="player-block">
      <label>Name: <input id="p1" type="text" placeholder="Player 1"></label>
      <label>Team: <input id="t1" type="text" placeholder="Team 1"></label>
      <label>Controller:
        <select id="c1">
          <option value="">None</option>
          <option value="arcade">Arcade Stick</option>
          <option value="leverless">Leverless</option>
          <option value="gamepad">Gamepad</option>
          <option value="arcade_white">Arcade Stick White</option>
          <option value="leverless_white">Leverless White</option>
          <option value="gamepad_white">Gamepad White</option>
        </select>
      </label>
      <label>Score: <input id="s1" type="number" value="0"></label>
    </div>

    <!-- Player 2 -->
    <div class="player-block">
      <label>Name: <input id="p2" type="text" placeholder="Player 2"></label>
      <label>Team: <input id="t2" type="text" placeholder="Team 2"></label>
      <label>Controller:
        <select id="c2">
          <option value="">None</option>
          <option value="arcade">Arcade Stick</option>
          <option value="leverless">Leverless</option>
          <option value="gamepad">Gamepad</option>
          <option value="arcade_white">Arcade Stick White</option>
          <option value="leverless_white">Leverless White</option>
          <option value="gamepad_white">Gamepad White</option>
        </select>
      </label>
      <label>Score: <input id="s2" type="number" value="0"></label>
    </div>

    <!-- Player 3 (2XKO only) -->
    <div class="player-block" id="p3block" style="display:none;">
      <span class="checkbox-label">
        <input type="checkbox" id="v3"> Visible
      </span>
      <label>Name: <input id="p3" type="text" placeholder="Player 3"></label>
      <label>Team: <input id="t3" type="text" placeholder="Team 3"></label>
      <label>Controller:
        <select id="c3">
          <option value="">None</option>
          <option value="arcade">Arcade Stick</option>
          <option value="leverless">Leverless</option>
          <option value="gamepad">Gamepad</option>
          <option value="arcade_white">Arcade Stick White</option>
          <option value="leverless_white">Leverless White</option>
          <option value="gamepad_white">Gamepad White</option>
        </select>
      </label>
      <label>Score: <input id="s3" type="number" value="0"></label>
    </div>

    <!-- Player 4 (2XKO only) -->
    <div class="player-block" id="p4block" style="display:none;">
      <span class="checkbox-label">
        <input type="checkbox" id="v4"> Visible
      </span>
      <label>Name: <input id="p4" type="text" placeholder="Player 4"></label>
      <label>Team: <input id="t4" type="text" placeholder="Team 4"></label>
      <label>Controller:
        <select id="c4">
          <option value="">None</option>
          <option value="arcade">Arcade Stick</option>
          <option value="leverless">Leverless</option>
          <option value="gamepad">Gamepad</option>
          <option value="arcade_white">Arcade Stick White</option>
          <option value="leverless_white">Leverless White</option>
          <option value="gamepad_white">Gamepad White</option>
        </select>
      </label>
      <label>Score: <input id="s4" type="number" value="0"></label>
    </div>
  </div> <!-- end scoreboard tab -->

    <!-- COMMENTARY -->
    <div id="commentary" class="tabcontent">
      <div class="commentary-panel">
        <h2 style="margin-top:0">Commentary Lower Third</h2>
        <div class="commentator-block">
          <label>Commentator 1 - Name<input id="com1_name" type="text" placeholder="Commentator 1"></label>
          <label>Commentator 1 - Description<input id="com1_desc" type="text" placeholder="FGC Expert"></label>
        </div>

        <div class="commentator-block">
          <label>Commentator 2 - Name<input id="com2_name" type="text" placeholder="Commentator 2"></label>
          <label>Commentator 2 - Description<input id="com2_desc" type="text" placeholder="Studio Host"></label>
        </div>

        <div class="commentary-toolbar">
          <button class="btn" onclick="updateCommentary()">üíæ Save Commentary</button>
          <button class="btn" onclick="resetCommentary()">üîÑ Reset Commentary</button>
          <button class="btn" onclick="toggleCommentary(true)">‚ñ∂ Show</button>
          <button class="btn" onclick="toggleCommentary(false)">‚èπ Hide</button>
        </div>
      </div>
    </div>

    <!-- BRACKETS -->
    <div id="brackets" class="tabcontent">
      <div class="bracket-panel">
        <h2 style="margin-top:0">Brackets ‚Äî Single Elimination (Top 8)</h2>

        <div class="inner-tabs" style="margin-bottom:14px">
          <button id="singleTabBtn" class="active" onclick="openInnerTab('single')">Single Elimination</button>
          <button id="doubleTabBtn" onclick="openInnerTab('double')">Double Elimination</button>
        </div>

        <!-- Single elimination UI (will be loaded from bracket_single.html) -->
        <div id="single" class="inner-tabcontent" style="display:block"></div>

        <!-- Double elimination UI (will be loaded from bracket_double.html) -->
        <div id="double" class="inner-tabcontent" style="display:none"></div>
  </div>

<script>
/* ---------------------
   Utility + tabs
   --------------------- */
function openTab(evt, tabName){
  document.querySelectorAll(".tabcontent").forEach(el=>el.classList.remove("active"));
  document.querySelectorAll(".tablinks").forEach(el=>el.classList.remove("active"));
  document.getElementById(tabName).classList.add("active");
  evt.currentTarget.classList.add("active");
}

function openInnerTab(name){
  document.querySelectorAll(".inner-tabcontent").forEach(el=>el.style.display="none");
  document.querySelectorAll(".inner-tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(name).style.display="block";
  document.getElementById(name + "TabBtn") && document.getElementById(name + "TabBtn").classList.add("active");
}

/* ---------------------
   Scoreboard logic (unchanged)
   --------------------- */
function toggleGameMode(){
  const game = document.getElementById("game").value;
  const p3 = document.getElementById("p3block");
  const p4 = document.getElementById("p4block");
  if(p3) p3.style.display = (game==="2xko")?"flex":"none";
  if(p4) p4.style.display = (game==="2xko")?"flex":"none";
}

async function updateScoreboard(){
  const data = {
    game: document.getElementById("game").value,
    style: document.getElementById("style").value,
    titlecard: document.getElementById("titlecard").value,
    player1: document.getElementById("p1").value,
    team1: document.getElementById("t1").value,
    controller1: document.getElementById("c1").value,
    score1: parseInt(document.getElementById("s1").value||0,10),
    player2: document.getElementById("p2").value,
    team2: document.getElementById("t2").value,
    controller2: document.getElementById("c2").value,
    score2: parseInt(document.getElementById("s2").value||0,10),
    player3: document.getElementById("p3")?.value||"",
    team3: document.getElementById("t3")?.value||"",
    controller3: document.getElementById("c3")?.value||"",
    score3: parseInt(document.getElementById("s3")?.value||0,10),
    visible3: document.getElementById("v3")?.checked??false,
    player4: document.getElementById("p4")?.value||"",
    team4: document.getElementById("t4")?.value||"",
    controller4: document.getElementById("c4")?.value||"",
    score4: parseInt(document.getElementById("s4")?.value||0,10),
    visible4: document.getElementById("v4")?.checked??false
  };
  try{
    await window.go.main.App.SaveScoreboardJSON(data);
  }catch(err){
    console.error("SaveScoreboardJSON failed:",err);
    alert("Error saving scoreboard JSON (see console).");
  }
}

function resetScoreboard(){
  // limit reset to scoreboard form inputs only (avoid wiping bracket seeds by accident)
  const selectors = ['#p1','#t1','#s1','#c1','#p2','#t2','#s2','#c2','#p3','#t3','#s3','#c3','#p4','#t4','#s4','#c4','#titlecard'];
  selectors.forEach(sel=>{ const el = document.querySelector(sel); if(el) el.value = (el.type==='number')?0:''; });
  const v3 = document.getElementById("v3"), v4 = document.getElementById("v4");
  if(v3) v3.checked=false; if(v4) v4.checked=false;
  updateScoreboard();
}

/* ---------------------
   Commentary logic (unchanged behavior)
   --------------------- */
let commentaryVisible = false;

async function updateCommentary(){
  const data = {
    commentator1: document.getElementById("com1_name").value||"",
    description1: document.getElementById("com1_desc").value||"",
    commentator2: document.getElementById("com2_name").value||"",
    description2: document.getElementById("com2_desc").value||"",
    visible: commentaryVisible
  };
  try{
    await window.go.main.App.SaveCommentaryJSON(data);
  }catch(err){
    console.error("SaveCommentaryJSON failed:",err);
    alert("Error saving commentary JSON (see console).");
  }
}

function resetCommentary(){
  document.getElementById("com1_name").value="";
  document.getElementById("com1_desc").value="";
  document.getElementById("com2_name").value="";
  document.getElementById("com2_desc").value="";
  updateCommentary();
}

async function toggleCommentary(show){
  commentaryVisible = show;
  const data = {
    commentator1: document.getElementById("com1_name").value||"",
    description1: document.getElementById("com1_desc").value||"",
    commentator2: document.getElementById("com2_name").value||"",
    description2: document.getElementById("com2_desc").value||"",
    visible: show
  };
  try{
    await window.go.main.App.SaveCommentaryJSON(data);
  }catch(err){
    console.error("SaveCommentaryJSON failed:",err);
    alert("Error saving commentary JSON (see console).");
  }
}

/* ---------------------
   Bracket data & functions (keeps previous IDs/logic)
   --------------------- */

let bracketData = null;

function ensureBracket(){
  if(!bracketData){
    bracketData = { single: { players: Array(8).fill(""), scores: {}, winners: {} }, double: { players: Array(8).fill(""), scores: {}, winners:{}, meta:{} } };
  }
}

async function loadBracket(){
  ensureBracket();
  try{
    const resp = await fetch("bracket.json?_=" + Date.now());
    if(!resp.ok) throw new Error("no bracket.json");
    const data = await resp.json();
    bracketData = data;
  }catch(err){
    console.warn("No bracket.json found ‚Äì using blank bracket");
  }
  renderSingleFromData();
  renderDoubleFromData();
}

function renderSingleFromData(){
  ensureBracket();
  const s = bracketData.single || { players: Array(8).fill(""), scores:{}, winners:{} };

  // seed inputs sp1..sp8 (we assume order [1..8])
  (s.players || Array(8).fill("")).forEach((p,i)=>{
    const el = document.getElementById("sp"+(i+1));
    if(el) el.value = p||"";
  });

  // map seeds into QF pairs (consistent with saveSinglePlayers):
  const players = s.players || Array(8).fill("");
  const qfPairs = {
    qf1: [players[0]||"", players[7]||""], // 1 vs 8
    qf2: [players[3]||"", players[4]||""], // 4 vs 5
    qf3: [players[2]||"", players[5]||""], // 3 vs 6
    qf4: [players[1]||"", players[6]||""]  // 2 vs 7
  };

  // fill QF names and scores using the actual IDs in the DOM (qf1p1, qf1s1 etc.)
  Object.keys(qfPairs).forEach(k=>{
    const aName = qfPairs[k][0]||"‚Äî";
    const bName = qfPairs[k][1]||"‚Äî";
    const aSpan = document.getElementById(k + "p1");
    const bSpan = document.getElementById(k + "p2");
    if(aSpan) aSpan.textContent = aName;
    if(bSpan) bSpan.textContent = bName;

    const sc = (s.scores && s.scores[k]) ? s.scores[k] : [null,null];
    const aScoreEl = document.getElementById(k + "s1");
    const bScoreEl = document.getElementById(k + "s2");
    if(aScoreEl) aScoreEl.value = sc[0] != null ? sc[0] : "";
    if(bScoreEl) bScoreEl.value = sc[1] != null ? sc[1] : "";
  });

  // semis winners mapping (if winners saved) or blank placeholders
  const sf1a = (s.winners && s.winners['qf1']) ? s.winners['qf1'] : "Winner QF1";
  const sf1b = (s.winners && s.winners['qf2']) ? s.winners['qf2'] : "Winner QF2";
  const sf2a = (s.winners && s.winners['qf3']) ? s.winners['qf3'] : "Winner QF3";
  const sf2b = (s.winners && s.winners['qf4']) ? s.winners['qf4'] : "Winner QF4";

  const sf1p1 = document.getElementById("sf1p1"); if(sf1p1) sf1p1.textContent = sf1a;
  const sf1p2 = document.getElementById("sf1p2"); if(sf1p2) sf1p2.textContent = sf1b;
  const sf2p1 = document.getElementById("sf2p1"); if(sf2p1) sf2p1.textContent = sf2a;
  const sf2p2 = document.getElementById("sf2p2"); if(sf2p2) sf2p2.textContent = sf2b;

  if(s.scores && s.scores['sf1']){ const el1 = document.getElementById('sf1s1'); const el2 = document.getElementById('sf1s2'); if(el1) el1.value = s.scores['sf1'][0]; if(el2) el2.value = s.scores['sf1'][1]; }
  if(s.scores && s.scores['sf2']){ const el1 = document.getElementById('sf2s1'); const el2 = document.getElementById('sf2s2'); if(el1) el1.value = s.scores['sf2'][0]; if(el2) el2.value = s.scores['sf2'][1]; }

  // final
  const fA = (s.winners && s.winners['sf1']) ? s.winners['sf1'] : "Winner SF1";
  const fB = (s.winners && s.winners['sf2']) ? s.winners['sf2'] : "Winner SF2";
  const f1p1 = document.getElementById("f1p1"); if(f1p1) f1p1.textContent = fA;
  const f1p2 = document.getElementById("f1p2"); if(f1p2) f1p2.textContent = fB;
  if(s.scores && s.scores['f1']){ const el1 = document.getElementById('f1s1'); const el2 = document.getElementById('f1s2'); if(el1) el1.value = s.scores['f1'][0]; if(el2) el2.value = s.scores['f1'][1]; }

  // visually highlight winners if desired
  highlightWinners(s);
}

function highlightWinners(s){
  // soft visual: apply .win to the player-line that matches saved winners
  ['qf1','qf2','qf3','qf4','sf1','sf2','f1'].forEach(mid=>{
    const winner = s.winners && s.winners[mid] ? s.winners[mid] : null;
    // containers may be the first or second .player-line inside the match
    const matchEl = document.getElementById(mid);
    if(!matchEl) return;
    const lines = matchEl.querySelectorAll('.player-line');
    lines.forEach(l=>{ l.classList.remove('win','lose'); });
    if(winner){
      lines.forEach(l=>{
        const nameSpan = l.querySelector('span');
        if(nameSpan && nameSpan.textContent.trim() === winner){ l.classList.add('win'); }
      });
      // mark others as lose
      lines.forEach(l=>{ if(!l.classList.contains('win')) l.classList.add('lose'); });
    }
  });
}

// store top 8
async function saveSinglePlayers(){
  ensureBracket();
  const arr = [
    document.getElementById("sp1").value || "",
    document.getElementById("sp2").value || "",
    document.getElementById("sp3").value || "",
    document.getElementById("sp4").value || "",
    document.getElementById("sp5").value || "",
    document.getElementById("sp6").value || "",
    document.getElementById("sp7").value || "",
    document.getElementById("sp8").value || ""
  ];
  bracketData.single.players = arr;
  bracketData.single.scores = {};
  bracketData.single.winners = {};
  await saveBracket();
  renderSingleFromData();

  // ALSO populate the visual bracket (qf / sf / final) so updateBracket() can operate
  // seeding: seed1 -> top-left, seed8 -> top-right, seed4 vs seed5, seed3 vs seed6, seed2 vs seed7
  try{
    // Quarterfinals
    document.getElementById("qf1p1").textContent = arr[0] || "‚Äî"; // seed1
    document.getElementById("qf1p2").textContent = arr[7] || "‚Äî"; // seed8

    document.getElementById("qf2p1").textContent = arr[3] || "‚Äî"; // seed4
    document.getElementById("qf2p2").textContent = arr[4] || "‚Äî"; // seed5

    document.getElementById("qf3p1").textContent = arr[2] || "‚Äî"; // seed3
    document.getElementById("qf3p2").textContent = arr[5] || "‚Äî"; // seed6

    document.getElementById("qf4p1").textContent = arr[1] || "‚Äî"; // seed2
    document.getElementById("qf4p2").textContent = arr[6] || "‚Äî"; // seed7

    // clear scores and downstream slots
    ["qf1s1","qf1s2","qf2s1","qf2s2","qf3s1","qf3s2","qf4s1","qf4s2","sf1s1","sf1s2","sf2s1","sf2s2","f1s1","f1s2"].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.value = "";
    });
    document.getElementById("sf1p1").textContent = "Winner QF1";
    document.getElementById("sf1p2").textContent = "Winner QF2";
    document.getElementById("sf2p1").textContent = "Winner QF3";
    document.getElementById("sf2p2").textContent = "Winner QF4";
    document.getElementById("f1p1").textContent = "Winner SF1";
    document.getElementById("f1p2").textContent = "Winner SF2";
  }catch(e){
    // if visual elements missing, ignore
    console.warn("Could not populate visual bracket:", e);
  }

  // ensure bracket progression recalculates
  updateBracket();
}

async function saveBracket(){
  ensureBracket();
  try{
    await window.go.main.App.SaveBracketJSON(bracketData);
    console.log("bracket saved");
  }catch(err){
    console.error("SaveBracketJSON failed:",err);
    alert("Error saving bracket (see console).");
  }
}

function resetBracket(){
  bracketData = { single: { players: Array(8).fill(""), scores:{}, winners:{} }, double: { players: Array(8).fill(""), scores:{}, winners:{}, meta:{} } };
  saveBracket();
  renderSingleFromData();
}

function updateBracket() {
      ensureBracket();
      const getVal = id => {
        const raw = document.getElementById(id)?.value;
        return (raw === undefined || raw === null || raw === '') ? null : Number(raw);
      };

      const qf1a = getVal('qf1s1');
      const qf1b = getVal('qf1s2');
      const qf2a = getVal('qf2s1');
      const qf2b = getVal('qf2s2');
      const qf3a = getVal('qf3s1');
      const qf3b = getVal('qf3s2');
      const qf4a = getVal('qf4s1');
      const qf4b = getVal('qf4s2');

      // update scores in memory
      bracketData.single.scores = bracketData.single.scores || {};
      bracketData.single.scores['qf1'] = [qf1a, qf1b];
      bracketData.single.scores['qf2'] = [qf2a, qf2b];
      bracketData.single.scores['qf3'] = [qf3a, qf3b];
      bracketData.single.scores['qf4'] = [qf4a, qf4b];

      // advance from QF -> SF
      if(qf1a !== null && qf1b !== null && qf1a !== qf1b){
        const winner = (qf1a > qf1b) ? document.getElementById("qf1p1").textContent : document.getElementById("qf1p2").textContent;
        document.getElementById("sf1p1").textContent = winner;
        bracketData.single.winners['qf1'] = winner;
      } else {
        document.getElementById("sf1p1").textContent = "Winner QF1";
        delete bracketData.single.winners['qf1'];
      }

      if(qf2a !== null && qf2b !== null && qf2a !== qf2b){
        const winner = (qf2a > qf2b) ? document.getElementById("qf2p1").textContent : document.getElementById("qf2p2").textContent;
        document.getElementById("sf1p2").textContent = winner;
        bracketData.single.winners['qf2'] = winner;
      } else {
        document.getElementById("sf1p2").textContent = "Winner QF2";
        delete bracketData.single.winners['qf2'];
      }

      if(qf3a !== null && qf3b !== null && qf3a !== qf3b){
        const winner = (qf3a > qf3b) ? document.getElementById("qf3p1").textContent : document.getElementById("qf3p2").textContent;
        document.getElementById("sf2p1").textContent = winner;
        bracketData.single.winners['qf3'] = winner;
      } else {
        document.getElementById("sf2p1").textContent = "Winner QF3";
        delete bracketData.single.winners['qf3'];
      }

      if(qf4a !== null && qf4b !== null && qf4a !== qf4b){
        const winner = (qf4a > qf4b) ? document.getElementById("qf4p1").textContent : document.getElementById("qf4p2").textContent;
        document.getElementById("sf2p2").textContent = winner;
        bracketData.single.winners['qf4'] = winner;
      } else {
        document.getElementById("sf2p2").textContent = "Winner QF4";
        delete bracketData.single.winners['qf4'];
      }

      // SF -> Final
      const sf1a = getVal('sf1s1');
      const sf1b = getVal('sf1s2');
      const sf2a = getVal('sf2s1');
      const sf2b = getVal('sf2s2');

      bracketData.single.scores['sf1'] = [sf1a, sf1b];
      bracketData.single.scores['sf2'] = [sf2a, sf2b];

      if(sf1a !== null && sf1b !== null && sf1a !== sf1b){
        const winner = (sf1a > sf1b) ? document.getElementById("sf1p1").textContent : document.getElementById("sf1p2").textContent;
        document.getElementById("f1p1").textContent = winner;
        bracketData.single.winners['sf1'] = winner;
      } else {
        document.getElementById("f1p1").textContent = "Winner SF1";
        delete bracketData.single.winners['sf1'];
      }

      if(sf2a !== null && sf2b !== null && sf2a !== sf2b){
        const winner = (sf2a > sf2b) ? document.getElementById("sf2p1").textContent : document.getElementById("sf2p2").textContent;
        document.getElementById("f1p2").textContent = winner;
        bracketData.single.winners['sf2'] = winner;
      } else {
        document.getElementById("f1p2").textContent = "Winner SF2";
        delete bracketData.single.winners['sf2'];
      }

      // final scores
      const f1a = getVal('f1s1');
      const f1b = getVal('f1s2');
      bracketData.single.scores['f1'] = [f1a, f1b];

      // update highlight
      highlightWinners(bracketData.single);
}

// only attach update listeners to bracket inputs (not every input on the page)
function attachBracketListeners(){
  const inputs = document.querySelectorAll('#visualBracket input[type=number]');
  inputs.forEach(input => {
    input.removeEventListener('input', updateBracket);
    input.addEventListener('input', updateBracket);
  });
}


    document.addEventListener('DOMContentLoaded', ()=>{
      attachBracketListeners();
    });

    function resetSingle(){
  ensureBracket();
  // Clear all seed inputs
  for(let i=1;i<=8;i++){
    const el = document.getElementById("sp"+i);
    if(el) el.value = "";
  }

  // Reset bracketData.single
  bracketData.single = { players: Array(8).fill(""), scores:{}, winners:{} };

  // Reset all bracket spans + scores
  const placeholders = {
    qf1p1:"Player 1", qf1p2:"Player 2",
    qf2p1:"Player 3", qf2p2:"Player 4",
    qf3p1:"Player 5", qf3p2:"Player 6",
    qf4p1:"Player 7", qf4p2:"Player 8",
    sf1p1:"Winner QF1", sf1p2:"Winner QF2",
    sf2p1:"Winner QF3", sf2p2:"Winner QF4",
    f1p1:"Winner SF1", f1p2:"Winner SF2"
  };
  Object.keys(placeholders).forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.textContent = placeholders[id];
  });

  // Clear all score inputs
  const scoreInputs = document.querySelectorAll("#single input[type='number']");
  scoreInputs.forEach(inp=>inp.value="");

  highlightWinners(bracketData.single);

  // (optional) persist blank bracket to backend
  try{
    window.go.main.App.SaveBracketJSON(bracketData);
  }catch(e){
    console.warn("resetSingle: SaveBracketJSON not available",e);
  }
}


/* ---------------------
   Double bracket (simple store)
   --------------------- */
function renderDoubleFromData(){
  ensureBracket();
  const d = bracketData.double || { players: Array(8).fill("") };
  for(let i=1;i<=8;i++){
    const el = document.getElementById("dp"+i);
    if(el) el.value = (d.players && d.players[i-1]) ? d.players[i-1] : "";
  }
}

async function saveDoublePlayers(){
  ensureBracket();

  // read seed inputs dp1..dp8
  const arr = [
    document.getElementById("dp1")?.value || "",
    document.getElementById("dp2")?.value || "",
    document.getElementById("dp3")?.value || "",
    document.getElementById("dp4")?.value || "",
    document.getElementById("dp5")?.value || "",
    document.getElementById("dp6")?.value || "",
    document.getElementById("dp7")?.value || "",
    document.getElementById("dp8")?.value || ""
  ];

  // persist player seeds in bracketData.double
  bracketData.double = bracketData.double || {};
  bracketData.double.players = arr;
  bracketData.double.scores = bracketData.double.scores || {};
  bracketData.double.winners = bracketData.double.winners || {};

  try{
    await saveBracket(); // uses existing saveBracket() which saves bracketData
  }catch(err){
    console.warn("saveBracket failed:", err);
  }

  // mapping as requested:
  // dp1 -> wb_sf1_p1, dp2 -> wb_sf1_p2, dp3 -> wb_sf2_p1, dp4 -> wb_sf2_p2
  // dp5 -> lb_r1_m1_p1, dp6 -> lb_r1_m1_p2, dp7 -> lb_r1_m2_p1, dp8 -> lb_r1_m2_p2
  const set = (id, value) => {
    const el = document.getElementById(id);
    if(el){
      // prefer textContent for spans, if input exist set value
      if(el.tagName === 'INPUT') el.value = value;
      else el.textContent = value || '';
    }
  };

  set('wb_sf1_p1', arr[0] || 'Seed 1');
  set('wb_sf1_p2', arr[1] || 'Seed 2');
  set('wb_sf2_p1', arr[2] || 'Seed 3');
  set('wb_sf2_p2', arr[3] || 'Seed 4');

  set('lb_r1_m1_p1', arr[4] || 'Loser 1');
  set('lb_r1_m1_p2', arr[5] || 'Loser 2');
  set('lb_r1_m2_p1', arr[6] || 'Loser 3');
  set('lb_r1_m2_p2', arr[7] || 'Loser 4');

  // clear numeric inputs inside the double visual so new progression is clean
  document.querySelectorAll('#doubleVisual input[type="number"]').forEach(i=>i.value='');

  // reset downstream placeholders
  const placeholders = {
    'wb_final_p1': 'Winner SF1', 'wb_final_p2':'Winner SF2',
    'lb_r2_m1_p1':'Winner R1M1','lb_r2_m1_p2':'Loser SF1',
    'lb_r2_m2_p1':'Winner R1M2','lb_r2_m2_p2':'Loser SF2',
    'lb_final_p1':'Winner R2M1','lb_final_p2':'Winner R2M2',
    'gf_wb':'WB Winner','gf_lb':'LB Winner'
  };
  Object.entries(placeholders).forEach(([id,val])=> set(id, val));

  // hide gf reset area
  const gfReset = document.getElementById('gf_reset');
  if(gfReset) gfReset.style.display = 'none';

  // run progression
  if(typeof updateDoubleBracket === 'function') updateDoubleBracket();
}


function resetDouble(){
  // clear seed inputs dp1..dp8
  for(let i=1;i<=8;i++){
    const el = document.getElementById('dp'+i);
    if(el) el.value = '';
  }

  // clear bracketData.double and persist
  bracketData.double = { players: Array(8).fill(""), scores: {}, winners: {} };
  try{ saveBracket(); }catch(e){ console.warn('saveBracket failed', e); }

  // reset visual placeholders and clear numeric inputs
  const resetPlace = (id, val) => {
    const el = document.getElementById(id);
    if(el){
      if(el.tagName === 'INPUT') el.value = '';
      else el.textContent = val || '';
    }
  };

  resetPlace('wb_sf1_p1','Winner QF1'); resetPlace('wb_sf1_p2','Winner QF2');
  resetPlace('wb_sf2_p1','Winner QF3'); resetPlace('wb_sf2_p2','Winner QF4');

  resetPlace('lb_r1_m1_p1','Loser QF1'); resetPlace('lb_r1_m1_p2','Loser QF2');
  resetPlace('lb_r1_m2_p1','Loser QF3'); resetPlace('lb_r1_m2_p2','Loser QF4');

  resetPlace('wb_final_p1','Winner SF1'); resetPlace('wb_final_p2','Winner SF2');
  resetPlace('lb_r2_m1_p1','Winner R1M1'); resetPlace('lb_r2_m1_p2','Loser SF1');
  resetPlace('lb_r2_m2_p1','Winner R1M2'); resetPlace('lb_r2_m2_p2','Loser SF2');
  resetPlace('lb_final_p1','Winner R2M1'); resetPlace('lb_final_p2','Winner R2M2');
  resetPlace('gf_wb','WB Winner'); resetPlace('gf_lb','LB Winner');

  document.querySelectorAll('#doubleVisual input[type="number"]').forEach(i=>i.value='');

  // hide reset UI
  const gfReset = document.getElementById('gf_reset'); if(gfReset) gfReset.style.display='none';

  // re-run progression to clear state
  if(typeof updateDoubleBracket === 'function') updateDoubleBracket();
}
/* ---------------------
   Initialization
   --------------------- */
ensureBracket();
loadBracket();
</script>

<script>
function seedPlayers(){
  document.getElementById("wb_sf1p1").textContent=document.getElementById("sp1").value;
  document.getElementById("wb_sf1p2").textContent=document.getElementById("sp8").value;
  document.getElementById("wb_sf2p1").textContent=document.getElementById("sp4").value;
  document.getElementById("wb_sf2p2").textContent=document.getElementById("sp5").value;
  document.getElementById("wb_sf3p1").textContent=document.getElementById("sp3").value;
  document.getElementById("wb_sf3p2").textContent=document.getElementById("sp6").value;
  document.getElementById("wb_sf4p1").textContent=document.getElementById("sp2").value;
  document.getElementById("wb_sf4p2").textContent=document.getElementById("sp7").value;
}

function setMatch(matchId, nextWinId, nextLoseId){
  let p1=document.getElementById(matchId+"p1").textContent;
  let p2=document.getElementById(matchId+"p2").textContent;
  let s1=parseInt(document.getElementById(matchId+"s1").value)||0;
  let s2=parseInt(document.getElementById(matchId+"s2").value)||0;
  let winner=s1>s2?p1:p2;
  let loser=s1>s2?p2:p1;

  if(nextWinId){
    let slot=document.querySelector("#"+nextWinId+" span:empty, #"+nextWinId+" span:contains('Winner')");
    if(slot) slot.textContent=winner;
  }
  if(nextLoseId){
    let slot=document.querySelector("#"+nextLoseId+" span:empty, #"+nextLoseId+" span:contains('L ')");
    if(slot) slot.textContent=loser;
  }
}

function setGrandFinal(){
  let p1=document.getElementById("gfp1").textContent;
  let p2=document.getElementById("gfp2").textContent;
  let s1=parseInt(document.getElementById("gfs1").value)||0;
  let s2=parseInt(document.getElementById("gfs2").value)||0;
  if(s1>s2){
    alert("üèÜ Champion: "+p1);
  } else if(s2>s1){
    // LB Champ won, trigger reset
    document.getElementById("gf_reset").style.display="block";
    document.getElementById("gf_resetp1").textContent=p1;
    document.getElementById("gf_resetp2").textContent=p2;
  }
}

function finalizeChampion(){
  let p1=document.getElementById("gf_resetp1").textContent;
  let p2=document.getElementById("gf_resetp2").textContent;
  let s1=parseInt(document.getElementById("gf_resets1").value)||0;
  let s2=parseInt(document.getElementById("gf_resets2").value)||0;
  let champ=s1>s2?p1:p2;
  alert("üèÜ Champion: "+champ);
}
</script>


<script>
  // loadPartial: fetch HTML partial and inject into container
  async function loadPartial(containerId, filePath){
    try{
      const res = await fetch(filePath + '?_=' + Date.now());
      if(!res.ok) throw new Error('Failed to load ' + filePath);
      const html = await res.text();
      const container = document.getElementById(containerId);
      if(container) container.innerHTML = html;

      // re-attach bracket listeners if visual was injected
      attachBracketListeners();

      // call init hooks if present in the injected partial
      if(containerId === 'single' && typeof initSingle === 'function') initSingle();
      if(containerId === 'double' && typeof initDouble === 'function') initDouble();
    }catch(err){
      console.warn('loadPartial error:', filePath, err);
    }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    // load partials using new filenames to avoid conflicts with your existing single.html / double.html
    loadPartial('single','bracket_single.html');
    loadPartial('double','bracket_double.html');

    // existing init
    attachBracketListeners();
  });
</script>

</body>
</html>
