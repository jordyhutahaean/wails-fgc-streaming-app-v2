<style>
 
  /* manual positions for each match (example) */
#qf1 { top: 0; left: 0; }
#qf2 { top: 100px; left: 0; }
#qf3 { top: 200px; left: 0; }
#qf4 { top: 300px; left: 0; }

#sf1 { top: 10px; left: 10; }
#sf2 { top: 200px; left: 10; }

#f1  { top: 25px; left: 0; }

 
</style>

<div style="display:flex;gap:12px;align-items:flex-start;margin-top:10px;margin-bottom:12px;flex-wrap:wrap"> 
  <div style="flex:1;min-width:260px"> 
    <div class="bracket-top8" style="display:grid;grid-template-columns:1fr 1fr;gap:8px 12px"> 
      <label>Seed 1: <input id="dp1" type="text"></label> 
      <label>Seed 8: <input id="dp8" type="text"></label> 
      <label>Seed 4: <input id="dp4" type="text"></label> 
      <label>Seed 5: <input id="dp5" type="text"></label> 
      <label>Seed 3: <input id="dp3" type="text"></label> 
      <label>Seed 6: <input id="dp6" type="text"></label> 
      <label>Seed 2: <input id="dp2" type="text"></label> 
      <label>Seed 7: <input id="dp7" type="text"></label> 
    </div> 
    <div style="margin-top:8px;display:flex;gap:8px"> 
      <button class="btn" onclick="saveDoublePlayers()">💾 Save Top 8</button> 
      <button class="btn" onclick="resetDouble()">🔄 Reset Top 8</button> 
    </div> 
  </div> 
</div>

<div class="bracket-scroll-container">
  <div class="bracket-tree" id="doubleVisual" aria-label="Double-elim bracket">
    <!-- Winners bracket column -->
    <div class="round quarterfinal" style="left:0;">
      <div class="match" id="wb_qf1">
        <div class="player-line"><span id="wb_qf1_p1">Seed 1</span><input type="number" id="wb_qf1_s1"></div>
        <div class="player-line"><span id="wb_qf1_p2">Seed 8</span><input type="number" id="wb_qf1_s2"></div>
      </div>
      <div class="match" id="wb_qf2">
        <div class="player-line"><span id="wb_qf2_p1">Seed 4</span><input type="number" id="wb_qf2_s1"></div>
        <div class="player-line"><span id="wb_qf2_p2">Seed 5</span><input type="number" id="wb_qf2_s2"></div>
      </div>
      <div class="match" id="wb_qf3">
        <div class="player-line"><span id="wb_qf3_p1">Seed 3</span><input type="number" id="wb_qf3_s1"></div>
        <div class="player-line"><span id="wb_qf3_p2">Seed 6</span><input type="number" id="wb_qf3_s2"></div>
      </div>
      <div class="match" id="wb_qf4">
        <div class="player-line"><span id="wb_qf4_p1">Seed 2</span><input type="number" id="wb_qf4_s1"></div>
        <div class="player-line"><span id="wb_qf4_p2">Seed 7</span><input type="number" id="wb_qf4_s2"></div>
      </div>
    </div>

    <!-- Winners Semis / Winners Final -->
    <div class="round semifinal" style="left:300px;">
      <div class="match" id="wb_sf1">
        <div class="player-line"><span id="wb_sf1_p1">Winner QF1</span><input type="number" id="wb_sf1_s1"></div>
        <div class="player-line"><span id="wb_sf1_p2">Winner QF2</span><input type="number" id="wb_sf1_s2"></div>
      </div>
      <div class="match" id="wb_sf2">
        <div class="player-line"><span id="wb_sf2_p1">Winner QF3</span><input type="number" id="wb_sf2_s1"></div>
        <div class="player-line"><span id="wb_sf2_p2">Winner QF4</span><input type="number" id="wb_sf2_s2"></div>
      </div>
      <div class="match" id="wb_final" style="margin-top:40px;">
        <div class="player-line"><span id="wb_final_p1">Winner SF1</span><input type="number" id="wb_final_s1"></div>
        <div class="player-line"><span id="wb_final_p2">Winner SF2</span><input type="number" id="wb_final_s2"></div>
      </div>
    </div>

    <!-- Losers bracket (left-to-right progression, two rounds then final) -->
    <div class="round" style="left:150px; top:250px;">
      <div class="match" id="lb_r1_m1">
        <div class="player-line"><span id="lb_r1_m1_p1">Loser QF1</span><input type="number" id="lb_r1_m1_s1"></div>
        <div class="player-line"><span id="lb_r1_m1_p2">Loser QF2</span><input type="number" id="lb_r1_m1_s2"></div>
      </div>

      <div class="match" id="lb_r1_m2">
        <div class="player-line"><span id="lb_r1_m2_p1">Loser QF3</span><input type="number" id="lb_r1_m2_s1"></div>
        <div class="player-line"><span id="lb_r1_m2_p2">Loser QF4</span><input type="number" id="lb_r1_m2_s2"></div>
      </div>
    </div>

    <div class="round" style="left:300px; top:350px;">
      <div class="match" id="lb_r2_m1">
        <div class="player-line"><span id="lb_r2_m1_p1">Winner R1M1</span><input type="number" id="lb_r2_m1_s1"></div>
        <div class="player-line"><span id="lb_r2_m1_p2">Loser SF1</span><input type="number" id="lb_r2_m1_s2"></div>
      </div>

      <div class="match" id="lb_r2_m2">
        <div class="player-line"><span id="lb_r2_m2_p1">Winner R1M2</span><input type="number" id="lb_r2_m2_s1"></div>
        <div class="player-line"><span id="lb_r2_m2_p2">Loser SF2</span><input type="number" id="lb_r2_m2_s2"></div>
      </div>
    </div>

    <div class="round" style="left:450px; top:400px;">
      <div class="match" id="lb_final">
        <div class="player-line"><span id="lb_final_p1">Winner R2M1</span><input type="number" id="lb_final_s1"></div>
        <div class="player-line"><span id="lb_final_p2">Winner R2M2</span><input type="number" id="lb_final_s2"></div>
      </div>
    </div>

    <!-- Grand Final area -->
    <div class="round final" style="left:600px; top:200px;">
      <div class="match" id="grand_final">
        <div class="player-line"><span id="gf_wb">WB Winner</span><input type="number" id="gf_wb_s"></div>
        <div class="player-line"><span id="gf_lb">LB Winner</span><input type="number" id="gf_lb_s"></div>
      </div>
      
      <!-- Grand Final Reset (if LB winner wins first set) -->
      <div class="match" id="gf_reset" style="display:none; margin-top:20px; background:#ff4444;">
        <div style="text-align:center; font-weight:bold; margin-bottom:8px;">RESET - Final Set</div>
        <div class="player-line"><span id="gf_reset_p1">Player A</span><input type="number" id="gf_reset_s1"></div>
        <div class="player-line"><span id="gf_reset_p2">Player B</span><input type="number" id="gf_reset_s2"></div>
        <button class="btn" onclick="finalizeChampion()" style="margin-top:8px;">Declare Champion</button>
      </div>
    </div>
  </div>
</div>

<script>
/* double-elim init and logic */
function initDouble(){
  // attach listeners on all numeric inputs inside this partial
  const inputs = document.querySelectorAll('#double #doubleVisual input[type=number]');
  inputs.forEach(i => i.addEventListener('input', updateDoubleBracket));
  
  // populate from saved data
  setTimeout(()=>{ 
    populateDoubleFromData(); 
  }, 50);
}

/* helper functions */
function val(id){ 
  const v = document.getElementById(id)?.value; 
  return (v === '' || v === undefined) ? null : Number(v); 
}

function text(id){ 
  return document.getElementById(id)?.textContent || ''; 
}

function setText(id, v){ 
  const el = document.getElementById(id); 
  if(el) el.textContent = v; 
}

/* Main bracket update function */
function updateDoubleBracket(){
  ensureBracket();
  if(!bracketData.double) bracketData.double = { players: Array(8).fill(""), scores:{}, winners:{} };

  // Initialize scores object if it doesn't exist
  if(!bracketData.double.scores) bracketData.double.scores = {};
  if(!bracketData.double.winners) bracketData.double.winners = {};

  // 1) Winners QFs -> WB SF & route losers to LB R1
  const wbQfMappings = [
    ['wb_qf1','wb_sf1_p1','lb_r1_m1_p1'],
    ['wb_qf2','wb_sf1_p2','lb_r1_m1_p2'],
    ['wb_qf3','wb_sf2_p1','lb_r1_m2_p1'],
    ['wb_qf4','wb_sf2_p2','lb_r1_m2_p2']
  ];

  wbQfMappings.forEach(([mid, winTarget, loseTarget]) => {
    const a = val(mid + '_s1');
    const b = val(mid + '_s2');
    bracketData.double.scores[mid] = [a, b];
    
    if(a !== null && b !== null && a !== b){
      const winner = (a > b) ? text(mid + '_p1') : text(mid + '_p2');
      const loser = (a > b) ? text(mid + '_p2') : text(mid + '_p1');
      setText(winTarget, winner);
      setText(loseTarget, loser);
      bracketData.double.winners[mid] = winner;
    } else {
      setText(winTarget, 'Winner ' + mid.replace('_', ' ').toUpperCase());
      setText(loseTarget, 'Loser ' + mid.replace('_', ' ').toUpperCase());
      delete bracketData.double.winners[mid];
    }
  });

  // 2) LB R1 winners -> R2 slots
  [['lb_r1_m1','lb_r2_m1_p1'], ['lb_r1_m2','lb_r2_m2_p1']].forEach(([mid, winTarget]) => {
    const a = val(mid + '_s1');
    const b = val(mid + '_s2');
    bracketData.double.scores[mid] = [a, b];
    
    if(a !== null && b !== null && a !== b){
      const winner = (a > b) ? text(mid + '_p1') : text(mid + '_p2');
      setText(winTarget, winner);
      bracketData.double.winners[mid] = winner;
    } else {
      setText(winTarget, 'Winner ' + mid.replace('_', ' ').toUpperCase());
      delete bracketData.double.winners[mid];
    }
  });

  // 3) WB SF -> WB final, losers go to LB R2 second slot
  [['wb_sf1','wb_final_p1','lb_r2_m1_p2'], ['wb_sf2','wb_final_p2','lb_r2_m2_p2']].forEach(([mid, winTarget, loseTarget]) => {
    const a = val(mid + '_s1');
    const b = val(mid + '_s2');
    bracketData.double.scores[mid] = [a, b];
    
    if(a !== null && b !== null && a !== b){
      const winner = (a > b) ? text(mid + '_p1') : text(mid + '_p2');
      const loser = (a > b) ? text(mid + '_p2') : text(mid + '_p1');
      setText(winTarget, winner);
      setText(loseTarget, loser);
      bracketData.double.winners[mid] = winner;
    } else {
      setText(winTarget, 'Winner ' + mid.replace('_', ' ').toUpperCase());
      setText(loseTarget, 'Loser ' + mid.replace('_', ' ').toUpperCase());
      delete bracketData.double.winners[mid];
    }
  });

  // 4) LB R2: winners advance to LB final
  [['lb_r2_m1','lb_final_p1'], ['lb_r2_m2','lb_final_p2']].forEach(([mid, winTarget]) => {
    const a = val(mid + '_s1');
    const b = val(mid + '_s2');
    bracketData.double.scores[mid] = [a, b];
    
    if(a !== null && b !== null && a !== b){
      const winner = (a > b) ? text(mid + '_p1') : text(mid + '_p2');
      setText(winTarget, winner);
      bracketData.double.winners[mid] = winner;
    } else {
      setText(winTarget, 'Winner ' + mid.replace('_', ' ').toUpperCase());
      delete bracketData.double.winners[mid];
    }
  });

  // 5) LB final -> grand final LB side
  const lbFinalA = val('lb_final_s1');
  const lbFinalB = val('lb_final_s2');
  bracketData.double.scores['lb_final'] = [lbFinalA, lbFinalB];
  
  if(lbFinalA !== null && lbFinalB !== null && lbFinalA !== lbFinalB){
    const winner = (lbFinalA > lbFinalB) ? text('lb_final_p1') : text('lb_final_p2');
    setText('gf_lb', winner);
    bracketData.double.winners['lb_final'] = winner;
  } else {
    setText('gf_lb', 'LB Winner');
    delete bracketData.double.winners['lb_final'];
  }

  // 6) WB final -> grand final WB side
  const wbFinalA = val('wb_final_s1');
  const wbFinalB = val('wb_final_s2');
  bracketData.double.scores['wb_final'] = [wbFinalA, wbFinalB];
  
  if(wbFinalA !== null && wbFinalB !== null && wbFinalA !== wbFinalB){
    const winner = (wbFinalA > wbFinalB) ? text('wb_final_p1') : text('wb_final_p2');
    setText('gf_wb', winner);
    bracketData.double.winners['wb_final'] = winner;
  } else {
    setText('gf_wb', 'WB Winner');
    delete bracketData.double.winners['wb_final'];
  }

  // 7) Grand final logic
  const gfWbScore = val('gf_wb_s');
  const gfLbScore = val('gf_lb_s');
  bracketData.double.scores['grand_final'] = [gfWbScore, gfLbScore];

  // Handle grand final reset logic
  if(gfWbScore !== null && gfLbScore !== null && gfWbScore !== gfLbScore){
    if(gfWbScore > gfLbScore){
      // WB winner wins - tournament over
      alert('🏆 Champion: ' + text('gf_wb'));
      document.getElementById('gf_reset').style.display = 'none';
    } else {
      // LB winner wins - trigger reset
      document.getElementById('gf_reset').style.display = 'block';
      setText('gf_reset_p1', text('gf_wb'));
      setText('gf_reset_p2', text('gf_lb'));
    }
  } else {
    document.getElementById('gf_reset').style.display = 'none';
  }

  // Persist data
  try{ 
    if(window.go && window.go.main && window.go.main.App) {
      window.go.main.App.SaveBracketJSON(bracketData); 
    }
  } catch(e) { 
    console.log('SaveBracketJSON not available:', e);
  }

  // Visual highlighting
  highlightDoubleWinners();
}

function highlightDoubleWinners(){
  const matchIds = [
    'wb_qf1','wb_qf2','wb_qf3','wb_qf4','wb_sf1','wb_sf2','wb_final',
    'lb_r1_m1','lb_r1_m2','lb_r2_m1','lb_r2_m2','lb_final','grand_final'
  ];
  
  matchIds.forEach(mid => {
    const matchEl = document.getElementById(mid);
    if(!matchEl) return;
    
    // Remove existing highlights
    matchEl.querySelectorAll('.player-line').forEach(pl => {
      pl.classList.remove('win','lose');
    });
    
    const scores = bracketData.double.scores && bracketData.double.scores[mid];
    if(scores && scores[0] !== null && scores[1] !== null && scores[0] !== scores[1]){
      const winnerName = bracketData.double.winners && bracketData.double.winners[mid];
      if(winnerName){
        matchEl.querySelectorAll('.player-line').forEach(pl => {
          const nameSpan = pl.querySelector('span');
          if(nameSpan){
            if(nameSpan.textContent === winnerName){
              pl.classList.add('win');
            } else {
              pl.classList.add('lose');
            }
          }
        });
      }
    }
  });
}

/* Populate UI from saved bracket data */
function populateDoubleFromData(){
  ensureBracket();
  const d = bracketData.double || {};
  
  // Fill seed inputs (dp1-dp8)
  if(d.players && d.players.length >= 8){
    for(let i = 0; i < 8; i++){
      const el = document.getElementById('dp' + (i+1));
      if(el) el.value = d.players[i] || '';
    }
    
    // Map seeds into winners bracket (same seeding as single)
    setText('wb_qf1_p1', d.players[0] || 'Seed 1');  // 1 vs 8
    setText('wb_qf1_p2', d.players[7] || 'Seed 8');
    setText('wb_qf2_p1', d.players[3] || 'Seed 4');  // 4 vs 5
    setText('wb_qf2_p2', d.players[4] || 'Seed 5');
    setText('wb_qf3_p1', d.players[2] || 'Seed 3');  // 3 vs 6
    setText('wb_qf3_p2', d.players[5] || 'Seed 6');
    setText('wb_qf4_p1', d.players[1] || 'Seed 2');  // 2 vs 7
    setText('wb_qf4_p2', d.players[6] || 'Seed 7');
  }
  
  // Populate saved scores
  const scores = d.scores || {};
  Object.keys(scores).forEach(matchId => {
    const scoreArray = scores[matchId];
    if(scoreArray && scoreArray.length === 2){
      const s1El = document.getElementById(matchId + '_s1');
      const s2El = document.getElementById(matchId + '_s2');
      if(s1El) s1El.value = scoreArray[0] != null ? scoreArray[0] : '';
      if(s2El) s2El.value = scoreArray[1] != null ? scoreArray[1] : '';
    }
  });
  
  // Run full update to populate all derived fields
  updateDoubleBracket();
}

/* Called after saving double players to populate the visual bracket */
function seedDoubleVisualBracket(){
  // Get current seed values
  const seeds = [];
  for(let i = 1; i <= 8; i++){
    const el = document.getElementById('dp' + i);
    seeds.push(el ? el.value || '' : '');
  }
  
  // Map to visual bracket using standard tournament seeding
  setText('wb_qf1_p1', seeds[0] || 'Seed 1');  // 1 vs 8
  setText('wb_qf1_p2', seeds[7] || 'Seed 8');
  setText('wb_qf2_p1', seeds[3] || 'Seed 4');  // 4 vs 5
  setText('wb_qf2_p2', seeds[4] || 'Seed 5');
  setText('wb_qf3_p1', seeds[2] || 'Seed 3');  // 3 vs 6
  setText('wb_qf3_p2', seeds[5] || 'Seed 6');
  setText('wb_qf4_p1', seeds[1] || 'Seed 2');  // 2 vs 7
  setText('wb_qf4_p2', seeds[6] || 'Seed 7');
  
  // Clear all scores and reset downstream placeholders
  const allScoreInputs = document.querySelectorAll('#doubleVisual input[type="number"]');
  allScoreInputs.forEach(input => input.value = '');
  
  // Reset all placeholders
  setText('wb_sf1_p1', 'Winner QF1');
  setText('wb_sf1_p2', 'Winner QF2'); 
  setText('wb_sf2_p1', 'Winner QF3');
  setText('wb_sf2_p2', 'Winner QF4');
  setText('wb_final_p1', 'Winner SF1');
  setText('wb_final_p2', 'Winner SF2');
  
  setText('lb_r1_m1_p1', 'Loser QF1');
  setText('lb_r1_m1_p2', 'Loser QF2');
  setText('lb_r1_m2_p1', 'Loser QF3'); 
  setText('lb_r1_m2_p2', 'Loser QF4');
  setText('lb_r2_m1_p1', 'Winner R1M1');
  setText('lb_r2_m1_p2', 'Loser SF1');
  setText('lb_r2_m2_p1', 'Winner R1M2');
  setText('lb_r2_m2_p2', 'Loser SF2');
  setText('lb_final_p1', 'Winner R2M1');
  setText('lb_final_p2', 'Winner R2M2');
  setText('gf_wb', 'WB Winner');
  setText('gf_lb', 'LB Winner');
  
  // Hide reset section
  document.getElementById('gf_reset').style.display = 'none';
}

/* Grand Final Reset Handler */
function finalizeChampion(){
  const p1 = text('gf_reset_p1');
  const p2 = text('gf_reset_p2');
  const s1 = val('gf_reset_s1');
  const s2 = val('gf_reset_s2');
  
  if(s1 !== null && s2 !== null && s1 !== s2){
    const champion = s1 > s2 ? p1 : p2;
    alert('🏆 Champion: ' + champion);
    
    // Store the reset result
    if(!bracketData.double.scores) bracketData.double.scores = {};
    bracketData.double.scores['gf_reset'] = [s1, s2];
    bracketData.double.winners['gf_reset'] = champion;
    
    // Save bracket data
    try{ 
      if(window.go && window.go.main && window.go.main.App) {
        window.go.main.App.SaveBracketJSON(bracketData); 
      }
    } catch(e) { 
      console.log('SaveBracketJSON not available:', e);
    }
  }
}
</script>